<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="google-site-verification" content="gMiqErWj487BTNydQ4JwPWMijWfHq7w5bqkaC5JPH9c">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"poabob.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":true,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Goroutine Pool前言 近期對於 golang 的 goroutine 非常感興趣，因為只要在 func 面前下一個關鍵字 go dosomething()，就能過用同步的方式來達到異步的效果。 然而，goroutine 是額外開啟一個輕量化的執行緒去執行我們的任務，如果需要在一個大量開啟 goroutines 情境下使用的話，系統很容易因為無節制的使用 goroutines 而大規模進">
<meta property="og:type" content="article">
<meta property="og:title" content="如何實作 Goroutine Pool?">
<meta property="og:url" content="https://poabob.github.io/2023-09-15/Build-A-Goroutine-Pool/index.html">
<meta property="og:site_name" content="POABOB">
<meta property="og:description" content="Goroutine Pool前言 近期對於 golang 的 goroutine 非常感興趣，因為只要在 func 面前下一個關鍵字 go dosomething()，就能過用同步的方式來達到異步的效果。 然而，goroutine 是額外開啟一個輕量化的執行緒去執行我們的任務，如果需要在一個大量開啟 goroutines 情境下使用的話，系統很容易因為無節制的使用 goroutines 而大規模進">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://poabob.github.io/images/Build-A-Goroutine-Pool/goroutine_pool.drawio.png">
<meta property="og:image" content="https://poabob.github.io/images/Build-A-Goroutine-Pool/100000_100000.png">
<meta property="og:image" content="https://poabob.github.io/images/Build-A-Goroutine-Pool/1000000_100000.png">
<meta property="og:image" content="https://poabob.github.io/images/Build-A-Goroutine-Pool/10000000_100000.png">
<meta property="article:published_time" content="2023-09-15T03:26:31.000Z">
<meta property="article:modified_time" content="2023-09-16T11:01:03.086Z">
<meta property="article:author" content="POABOB">
<meta property="article:tag" content="goroutine">
<meta property="article:tag" content="goroutine-pool">
<meta property="article:tag" content="golang">
<meta property="article:tag" content="go">
<meta property="article:tag" content="Backend">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://poabob.github.io/images/Build-A-Goroutine-Pool/goroutine_pool.drawio.png">

<link rel="canonical" href="https://poabob.github.io/2023-09-15/Build-A-Goroutine-Pool/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-TW'
  };
</script>

  <title>如何實作 Goroutine Pool? | POABOB</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-162792341-1"></script>
    <script data-pjax>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-162792341-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">POABOB</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">小小工程師的筆記分享</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首頁</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>標籤</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分類</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>歸檔</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜尋..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://poabob.github.io/2023-09-15/Build-A-Goroutine-Pool/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="POABOB">
      <meta itemprop="description" content="Life is but a span!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="POABOB">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          如何實作 Goroutine Pool?
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2023-09-15 11:26:31" itemprop="dateCreated datePublished" datetime="2023-09-15T11:26:31+08:00">2023-09-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2023-09-16 19:01:03" itemprop="dateModified" datetime="2023-09-16T19:01:03+08:00">2023-09-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BE%8C%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">後端</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Goroutine-Pool"><a href="#Goroutine-Pool" class="headerlink" title="Goroutine Pool"></a>Goroutine Pool</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p>近期對於 golang 的 goroutine 非常感興趣，因為只要在 func 面前下一個關鍵字 <code>go dosomething()</code>，就能過用同步的方式來達到異步的效果。</p>
<p>然而，goroutine 是額外開啟一個輕量化的執行緒去執行我們的任務，如果需要在一個大量開啟 goroutines 情境下使用的話，系統很容易因為無節制的使用 goroutines 而大規模進行擴充與銷毀，這樣會造成 GC (Garbage Collection) 產生大量的壓力，從而影響我們的系統整體的效能。</p>
<p>並且 <code>runtime</code> 和 <code>GC</code> 都是 goroutine，如果 goroutine 的規模太過於龐大，記憶體無法有效進行調度， <code>Go Scheduler</code> 就會阻塞 goroutine，導致 <code>Processor</code> Local Queue 累積，造成記憶體溢出，最後有可能整個行程直接崩潰。</p>
</blockquote>
<a id="more"></a> 

<h2 id="介紹"><a href="#介紹" class="headerlink" title="介紹"></a>介紹</h2><p>一般來說，如果我們要避免我們的 goroutine <code>無限制的持續增長</code> 導致 <code>process</code> 崩潰，那麼就必需在使用前 <code>提前限制使用的數量</code>，如此一來，就能解決無限制增長的問題。</p>
<p>可是若是這樣單單的限制數量還不夠，因為 goroutine 是會被 <code>擴充</code> 和 <code>銷毀</code>，是不是一旦建立後，先 <code>保存起來重複使用</code>，<code>等待一定時間再進行銷毀</code>，就可以縮小 runtime 和 GC 運作的壓力。</p>
<p>假設現在有 <code>100萬</code> 個請求要併發執行，我們其實可以不用同等的規模建立100萬個 goroutine (<code>硬體可能不允許</code>)，但我們可以建立 <code>5萬個</code> 再低一點甚至是 <code>1萬個</code> 也可以，只要平均把請求分配至這 <code>1萬個</code> goroutine 同樣可以在 <code>系統穩定的前提下</code> 慢慢完成。</p>
<h2 id="設計思路"><a href="#設計思路" class="headerlink" title="設計思路"></a>設計思路</h2><ol>
<li>初始化一個 <code>Goroutine Pool</code>，設定 <code>最大</code> 的 Worker 數量。</li>
<li>該 Pool 是一個以 <code>Circular Queue</code> 實現 <code>FIFO</code> 的資料結構，主要負責存放要處理 task 的 Worker。</li>
<li>檢查 Pool 中是否有可用的 Worker。<ol>
<li>有，取出 Worker 執行 task。</li>
<li>沒有，判斷 Worker 數量是否超出 Pool 的最大限制。<ol>
<li>是，判斷 Pool 是否為 Non-Blocking。<ol>
<li>是，直接返回 <code>nil</code>。 </li>
<li>否，Blocking 等待 Worker 被放回 Pool。</li>
</ol>
</li>
<li>否，<code>創建</code> 一個新的 goroutine 作為 Worker 來執行 task。<ol>
<li>當 Worker 執行完任務，把它放回 Pool 中。</li>
<li>定時將 <code>閒置的 Worker</code> 清理。</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<p>流程圖如下所示：</p>
<p><img src="/images/Build-A-Goroutine-Pool/goroutine_pool.drawio.png" alt=""></p>
<h2 id="Goroutine-Pool-實作"><a href="#Goroutine-Pool-實作" class="headerlink" title="Goroutine Pool 實作"></a>Goroutine Pool 實作</h2><h3 id="定義-Pool-struct"><a href="#定義-Pool-struct" class="headerlink" title="定義 Pool struct"></a>定義 <code>Pool struct</code></h3><ul>
<li><code>capacity</code> 是我們 Pool 容量 <code>worker 的最大數量</code></li>
<li><code>running</code> 是 <code>正在執行 worker 數量</code></li>
<li><code>waiting</code>是 <code>任務阻塞等待的數量</code></li>
<li><code>workers</code> 是使用陣列實作 <code>circular queue</code> 的資料結構</li>
<li><code>state</code> 是當 Pool 的狀態，<code>Release()</code> 後會是關閉的，<code>Reboot()</code> 則是會重啟</li>
<li><code>lock</code> 是為了避免操作 worker 時候產生 data race</li>
<li><code>cond</code> 是要讓多出來的任務無法被 worker 馬上消化時，可以 <code>阻塞</code> 等待的一個類似 <code>waitGroup</code> 的功能</li>
<li><code>workerCache</code> 是要讓 worker <code>初始化</code> 或 <code>不執行時</code>，可以重複使用的一個 cache</li>
<li><code>clearDone</code>、<code>stopClear</code> 是用來表示 <code>定時清理</code> 的狀態和 <code>cancel function</code></li>
<li><code>options</code> 是 Pool 裡的設定</li>
</ul>
<p><code>pool.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Pool <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// pool 容量</span></span><br><span class="line">	capacity <span class="keyword">int32</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 正在執行的goroutine</span></span><br><span class="line">	running <span class="keyword">int32</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Blocking 的 task 數</span></span><br><span class="line">	waiting <span class="keyword">int32</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 閒置的Workers</span></span><br><span class="line">	workers workerQueue</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 警告Pool要自己close</span></span><br><span class="line">	state <span class="keyword">int32</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 鎖</span></span><br><span class="line">	lock sync.Mutex</span><br><span class="line"></span><br><span class="line">	<span class="comment">// worker 等待的鎖</span></span><br><span class="line">	cond *sync.Cond</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 回收使用過的Worker</span></span><br><span class="line">	workerCache sync.Pool</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Clear 是否完成</span></span><br><span class="line">	clearDone <span class="keyword">int32</span></span><br><span class="line">	stopClear context.CancelFunc</span><br><span class="line"></span><br><span class="line">	options *Options</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="定義-Options，客製化額外需求"><a href="#定義-Options，客製化額外需求" class="headerlink" title="定義 Options，客製化額外需求"></a>定義 <code>Options</code>，客製化額外需求</h3><p>此功能主要是能夠讓使用者<code>自主設定需要的功能</code>，若使用者不設定 Pool 也會有自己的預設模式。</p>
<p><code>option.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> grpool</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"time"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 參數設定</span></span><br><span class="line"><span class="keyword">type</span> Option <span class="function"><span class="keyword">func</span><span class="params">(opts *Options)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 加載設定</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">loadOptions</span><span class="params">(options ...Option)</span> *<span class="title">Options</span></span> &#123;</span><br><span class="line">	opts := <span class="built_in">new</span>(Options)</span><br><span class="line">	<span class="keyword">for</span> _, option := <span class="keyword">range</span> options &#123;</span><br><span class="line">		option(opts)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> opts</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 該設定會被用來引入至 Pool 中</span></span><br><span class="line"><span class="keyword">type</span> Options <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// 過期時間: 用於定時清理過期的 Worker (只要太久沒被使用的 Worker 就會被清理)，預設為 1 秒</span></span><br><span class="line">	ExpiryDuration time.Duration</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 是否提前申請空間，大量執行需求中使用</span></span><br><span class="line">	PreAlloc <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Nonblocking 用來阻塞任務</span></span><br><span class="line">	<span class="comment">// 若設定為 true，就會返回 ErrPoolOverload 錯誤</span></span><br><span class="line">	Nonblocking <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 用來處理 worker panic 發生的事件</span></span><br><span class="line">	PanicHandler <span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">interface</span>&#123;&#125;)</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 若設定為 true，Worker 就不會被自動清除</span></span><br><span class="line">	DisableClear <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 直接傳入 Options</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithOptions</span><span class="params">(options Options)</span> <span class="title">Option</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(opts *Options)</span></span> &#123;</span><br><span class="line">		*opts = options</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 設定過期時間</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithExpiryDuration</span><span class="params">(expiryDuration time.Duration)</span> <span class="title">Option</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(opts *Options)</span></span> &#123;</span><br><span class="line">		opts.ExpiryDuration = expiryDuration</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 設定是否要提前創建空間</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithPreAlloc</span><span class="params">(preAlloc <span class="keyword">bool</span>)</span> <span class="title">Option</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(opts *Options)</span></span> &#123;</span><br><span class="line">		opts.PreAlloc = preAlloc</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 若為 true，代表沒有有用的 Worker 時，會直接 ErrPoolOverload</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithNonblocking</span><span class="params">(nonblocking <span class="keyword">bool</span>)</span> <span class="title">Option</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(opts *Options)</span></span> &#123;</span><br><span class="line">		opts.Nonblocking = nonblocking</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Panic 事件處理</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithPanicHandler</span><span class="params">(panicHandler <span class="keyword">func</span>(<span class="keyword">interface</span>&#123;&#125;)</span>) <span class="title">Option</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(opts *Options)</span></span> &#123;</span><br><span class="line">		opts.PanicHandler = panicHandler</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 是否要關閉 Clear</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithDisableClear</span><span class="params">(disable <span class="keyword">bool</span>)</span> <span class="title">Option</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(opts *Options)</span></span> &#123;</span><br><span class="line">		opts.DisableClear = disable</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="初始化-Pool，加載-Options-並開啟自動清理"><a href="#初始化-Pool，加載-Options-並開啟自動清理" class="headerlink" title="初始化 Pool，加載 Options 並開啟自動清理"></a>初始化 Pool，加載 <code>Options</code> 並開啟自動清理</h3><p><code>pool.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewPool</span><span class="params">(size <span class="keyword">int</span>, options ...Option)</span> <span class="params">(*Pool, error)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 加載設定</span></span><br><span class="line">	opts := loadOptions(options...)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !opts.DisableClear &#123;</span><br><span class="line">		<span class="keyword">if</span> expiry := opts.ExpiryDuration; expiry &lt; <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, ErrInvalidPoolExpiry</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> expiry == <span class="number">0</span> &#123;</span><br><span class="line">			opts.ExpiryDuration = DefaultCleanIntervalTime</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 如果 size 不是一個有效的 Size 就使用 DefaultPoolSize</span></span><br><span class="line">	<span class="keyword">if</span> size &lt;= <span class="number">0</span> &#123;</span><br><span class="line">		size = DefaultPoolSize</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// init</span></span><br><span class="line">	p := &amp;Pool&#123;</span><br><span class="line">		capacity: <span class="keyword">int32</span>(size),</span><br><span class="line">		options:  opts,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 提前申請 worker</span></span><br><span class="line">	p.workerCache.New = <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line">		<span class="keyword">return</span> &amp;Worker&#123;</span><br><span class="line">			pool: p,</span><br><span class="line">			task: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="function"><span class="keyword">func</span><span class="params">()</span>, <span class="title">workerChanCap</span>),</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	p.cond = sync.NewCond(&amp;p.lock)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 circular queue</span></span><br><span class="line">	p.workers = newWorkerCircularQueue(size, p.options.PreAlloc)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 定期清理過期的worker，節省系統資源</span></span><br><span class="line">	p.goClear()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> p, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="定時清理過期的-Worker"><a href="#定時清理過期的-Worker" class="headerlink" title="定時清理過期的 Worker"></a>定時清理過期的 Worker</h3><p><code>ctx, p.stopClear = context.WithCancel(context.Background())</code></p>
<p>這是一個可以讓 goroutine 優雅取消的方式，只要呼叫 <code>p.stopClear()</code>，<code>ctx.Done()</code> 就會被傳入通知取消工作。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 開啟一個 goroutine 定時清理過期的 workers</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">goClear</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// 若設定不開啟就返回</span></span><br><span class="line">	<span class="keyword">if</span> p.options.DisableClear &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> ctx context.Context</span><br><span class="line">       <span class="comment">// p.stopClear() 呼叫的時候，會觸發 ctx.Done() 讓 goroutine 停止</span></span><br><span class="line">	ctx, p.stopClear = context.WithCancel(context.Background())</span><br><span class="line">	<span class="keyword">go</span> p.ClearStaleWorkers(ctx)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定時清理過期的 workers</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">ClearStaleWorkers</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">	ticker := time.NewTicker(p.options.ExpiryDuration)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		ticker.Stop()</span><br><span class="line">		atomic.StoreInt32(&amp;p.clearDone, <span class="number">1</span>)</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		<span class="keyword">case</span> &lt;-ticker.C:</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> p.IsClosed() &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		p.lock.Lock()</span><br><span class="line">		staleWorkers := p.workers.refresh(p.options.ExpiryDuration)</span><br><span class="line">		p.lock.Unlock()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> i := <span class="keyword">range</span> staleWorkers &#123;</span><br><span class="line">			staleWorkers[i].finish()</span><br><span class="line">			staleWorkers[i] = <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Pool-的基本操作，Pool-的狀態操作"><a href="#Pool-的基本操作，Pool-的狀態操作" class="headerlink" title="Pool 的基本操作，Pool 的狀態操作"></a>Pool 的基本操作，Pool 的狀態操作</h3><p>這邊使用 <code>&quot;sync/atomic&quot;</code> 這個函式庫是為了方便以原子性的方式執行狀態操作，避免 data race 和一直開關鎖。</p>
<p><code>pool.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 獲取 Pool 容量</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Cap</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">int</span>(atomic.LoadInt32(&amp;p.capacity))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Free returns the number of available goroutines to work, -1 indicates this pool is unlimited.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Free</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	c := p.Cap()</span><br><span class="line">	<span class="keyword">if</span> c &lt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> c - p.Running()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Waiting returns the number of tasks which are waiting be executed.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Waiting</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">int</span>(atomic.LoadInt32(&amp;p.waiting))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 獲取正在執行的 Worker 數量</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Running</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">int</span>(atomic.LoadInt32(&amp;p.running))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">addWaiting</span><span class="params">(delta <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	atomic.AddInt32(&amp;p.waiting, <span class="keyword">int32</span>(delta))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">addRunning</span><span class="params">(delta <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	atomic.AddInt32(&amp;p.running, <span class="keyword">int32</span>(delta))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判斷是否被關閉</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">IsClosed</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> atomic.LoadInt32(&amp;p.state) == CLOSED</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Pool-執行任務"><a href="#Pool-執行任務" class="headerlink" title="Pool 執行任務"></a>Pool 執行任務</h3><p><code>pool.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 獲取 worker 執行任務</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Schedule</span><span class="params">(task <span class="keyword">func</span>()</span>) <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// 判斷Pool是否被關閉</span></span><br><span class="line">	<span class="keyword">if</span> p.IsClosed() &#123;</span><br><span class="line">		<span class="keyword">return</span> ErrPoolClosed</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> w := p.getWorker(); w != <span class="literal">nil</span> &#123;</span><br><span class="line">		w.inputFunc(task)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ErrPoolOverload</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Pool-獲取-放回-Worker"><a href="#Pool-獲取-放回-Worker" class="headerlink" title="Pool 獲取/放回 Worker"></a>Pool 獲取/放回 Worker</h3><p>一開始，可以查看看 <code>workerCache</code> 中有沒有 worker，可以節省 <code>重複初始化 worker 的操作</code>，再來就是向 worker 取用一個實例。</p>
<p>如果 worker 有 <code>正常取到</code>，那就直接返回使用。</p>
<p>如果沒有 worker，那就判斷目前 Pool 大小是否允許再創建一個 worker，可以的話就 <code>直接創建</code>。</p>
<p>若都不行，就要 <code>阻塞等待</code> 其他 worker 處理完任務後，返回 Pool 時取用。</p>
<p><code>pool.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 獲取 worker 執行任務</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">getWorker</span><span class="params">()</span> <span class="params">(w worker)</span></span> &#123;</span><br><span class="line">	genWorker := <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> w = p.workerCache.Get().(*Worker); w == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="comment">// 新開一個worker</span></span><br><span class="line">			w = &amp;Worker&#123;</span><br><span class="line">				pool: p,</span><br><span class="line">				task: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="function"><span class="keyword">func</span><span class="params">()</span>, <span class="title">workerChanCap</span>),</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		w.run()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 加鎖</span></span><br><span class="line">	p.lock.Lock()</span><br><span class="line">	<span class="keyword">if</span> w = p.workers.detach(); w != <span class="literal">nil</span> &#123;</span><br><span class="line">		p.lock.Unlock()</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">cap</span> := p.Cap(); <span class="built_in">cap</span> &gt; p.Running() &#123;</span><br><span class="line">		<span class="comment">// if the worker queue is empty and we don't run out of the pool capacity,</span></span><br><span class="line">		<span class="comment">// then just spawn a new worker goroutine.</span></span><br><span class="line">		p.lock.Unlock()</span><br><span class="line">		<span class="comment">// 當前無可用worker，但是Pool沒有滿</span></span><br><span class="line">		genWorker()</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123; <span class="comment">// otherwise, we'll have to keep them blocked and wait for at least one worker to be put back into pool.</span></span><br><span class="line">		<span class="keyword">if</span> p.options.Nonblocking &#123;</span><br><span class="line">			p.lock.Unlock()</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			p.addWaiting(<span class="number">1</span>)</span><br><span class="line">			<span class="comment">// 阻塞等待</span></span><br><span class="line">			p.cond.Wait()</span><br><span class="line">			p.addWaiting(<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> p.IsClosed() &#123;</span><br><span class="line">				p.lock.Unlock()</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> w = p.workers.detach(); w != <span class="literal">nil</span> &#123;</span><br><span class="line">				p.lock.Unlock()</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> w == <span class="literal">nil</span> &amp;&amp; p.Free() &gt; <span class="number">0</span> &#123;</span><br><span class="line">				p.lock.Unlock()</span><br><span class="line">				genWorker()</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 將 Worker 放回 Pool</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">putWorker</span><span class="params">(worker *Worker)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="comment">// 避免 Worker 超出 Pool 容量，或是 Pool 已關閉</span></span><br><span class="line">	<span class="built_in">cap</span> := p.Cap()</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">cap</span> &gt; <span class="number">0</span> &amp;&amp; p.Running() &gt; <span class="built_in">cap</span>) || p.IsClosed() &#123;</span><br><span class="line">		p.cond.Broadcast()</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 紀錄Woker最後一次運行時間</span></span><br><span class="line">	worker.lastUpdatedTime = time.Now()</span><br><span class="line"></span><br><span class="line">	p.lock.Lock()</span><br><span class="line">	<span class="keyword">defer</span> p.lock.Unlock()</span><br><span class="line">	<span class="comment">// 避免記憶體溢出</span></span><br><span class="line">	<span class="keyword">if</span> p.IsClosed() &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := p.workers.insert(worker); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 把 Blocking 等待 worker 的 task 喚醒</span></span><br><span class="line">	p.cond.Signal()</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Pool-關閉與開啟"><a href="#Pool-關閉與開啟" class="headerlink" title="Pool 關閉與開啟"></a>Pool 關閉與開啟</h3><p><code>pool.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 清除 Pool 裡面的 Worker</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Release</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> !atomic.CompareAndSwapInt32(&amp;p.state, OPENED, CLOSED) &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> p.stopClear != <span class="literal">nil</span> &#123;</span><br><span class="line">		p.stopClear()</span><br><span class="line">		p.stopClear = <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	p.lock.Lock()</span><br><span class="line">	p.workers.reset()</span><br><span class="line">	p.lock.Unlock()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通知阻塞的 goroutine 繼續執行</span></span><br><span class="line">	p.cond.Broadcast()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重啟一個可以使用的 Pool</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Reboot</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;p.state, CLOSED, OPENED) &#123;</span><br><span class="line">		<span class="comment">// 重新啟用 Worker Queue</span></span><br><span class="line">		p.workers = newWorkerCircularQueue(<span class="keyword">int</span>(p.capacity), p.options.PreAlloc)</span><br><span class="line"></span><br><span class="line">		atomic.StoreInt32(&amp;p.clearDone, <span class="number">0</span>)</span><br><span class="line">		p.goClear()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Worker-的定義"><a href="#Worker-的定義" class="headerlink" title="Worker 的定義"></a><code>Worker</code> 的定義</h3><ul>
<li><code>run()</code>：執行並等待任務派發</li>
<li><code>finish()</code>：通知 worker 休息，並不用回收</li>
<li><code>getLastUpdatedTime()</code>：獲取 worker 最近執行時間</li>
<li><code>inputFunc()</code>：添加任務至正在執行的 worker</li>
</ul>
<p><code>worker.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> grpool</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"runtime/debug"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> worker <span class="keyword">interface</span> &#123;</span><br><span class="line">	run()</span><br><span class="line">	finish()</span><br><span class="line">	getLastUpdatedTime() time.Time</span><br><span class="line">	inputFunc(<span class="function"><span class="keyword">func</span><span class="params">()</span>)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Worker <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// 任務池</span></span><br><span class="line">	pool *Pool</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 任務 func() error</span></span><br><span class="line">	task <span class="keyword">chan</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 回收時間</span></span><br><span class="line">	lastUpdatedTime time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *Worker)</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">	w.pool.addRunning(<span class="number">1</span>)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="comment">// 回收 Pool 失敗或 worker 發生錯誤</span></span><br><span class="line">		<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			w.pool.addRunning(<span class="number">-1</span>)</span><br><span class="line">			<span class="comment">// worker 放 cache 可以不用重新初始化</span></span><br><span class="line">			w.pool.workerCache.Put(w)</span><br><span class="line">			<span class="keyword">if</span> p := <span class="built_in">recover</span>(); p != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> ph := w.pool.options.PanicHandler; ph != <span class="literal">nil</span> &#123;</span><br><span class="line">					ph(p)</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					fmt.Printf(<span class="string">"worker exited from panic: %v\n%s\n"</span>, p, debug.Stack())</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// 喚醒 Blocking 的 task</span></span><br><span class="line">			w.pool.cond.Signal()</span><br><span class="line">		&#125;()</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 監聽任務列表，有任務就拿出來執行</span></span><br><span class="line">		<span class="keyword">for</span> f := <span class="keyword">range</span> w.task &#123;</span><br><span class="line">			<span class="comment">// 被 finish()</span></span><br><span class="line">			<span class="keyword">if</span> f == <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 執行任務</span></span><br><span class="line">			f()</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 回收worker</span></span><br><span class="line">			<span class="keyword">if</span> ok := w.pool.putWorker(w); !ok &#123;</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *Worker)</span> <span class="title">finish</span><span class="params">()</span></span> &#123;</span><br><span class="line">	w.task &lt;- <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *Worker)</span> <span class="title">getLastUpdatedTime</span><span class="params">()</span> <span class="title">time</span>.<span class="title">Time</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> w.lastUpdatedTime</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *Worker)</span> <span class="title">inputFunc</span><span class="params">(fn <span class="keyword">func</span>()</span>)</span> &#123;</span><br><span class="line">	w.task &lt;- fn</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="Worker-Queue-的實現"><a href="#Worker-Queue-的實現" class="headerlink" title="Worker Queue 的實現"></a><code>Worker Queue</code> 的實現</h3><ul>
<li><code>len()</code>：獲取目前 worker 在 Queue 中的數量</li>
<li><code>isEmpty()</code>：判斷目前 Queue 中是否為空</li>
<li><code>insert()</code>：插入一個 worker 至 Queue 裡</li>
<li><code>detach()</code>：從 Queue 獲取一個 worker</li>
<li><code>refresh()</code>：清理 Queue 中 過期的 worker</li>
<li><code>reset()</code>：重置整個 Queue</li>
</ul>
<p><code>worker_circular_queue.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> grpool</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"errors"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	<span class="comment">// Queue 滿了</span></span><br><span class="line">	errQueueIsFull = errors.New(<span class="string">"the circular queue is full"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Queue 已經關閉了</span></span><br><span class="line">	errQueueIsReleased = errors.New(<span class="string">"the circular queue length is zero"</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> workerQueue <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="built_in">len</span>() <span class="keyword">int</span></span><br><span class="line">	isEmpty() <span class="keyword">bool</span></span><br><span class="line">	insert(worker) error</span><br><span class="line">	detach() worker</span><br><span class="line">	refresh(duration time.Duration) []worker</span><br><span class="line">	reset()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// workerQueue 的實現</span></span><br><span class="line"><span class="keyword">type</span> circularQueue <span class="keyword">struct</span> &#123;</span><br><span class="line">	items      []worker</span><br><span class="line">	expiry     []worker</span><br><span class="line">	head       <span class="keyword">int</span></span><br><span class="line">	tail       <span class="keyword">int</span></span><br><span class="line">	size       <span class="keyword">int</span></span><br><span class="line">	isFull     <span class="keyword">bool</span></span><br><span class="line">	isPreAlloc <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化 WorkerCircularQueue</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newWorkerCircularQueue</span><span class="params">(size <span class="keyword">int</span>, preAlloc <span class="keyword">bool</span>)</span> *<span class="title">circularQueue</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> preAlloc &#123;</span><br><span class="line">		<span class="keyword">return</span> &amp;circularQueue&#123;</span><br><span class="line">			items:      <span class="built_in">make</span>([]worker, size),</span><br><span class="line">			size:       size,</span><br><span class="line">			isPreAlloc: preAlloc,</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;circularQueue&#123;</span><br><span class="line">		items:      <span class="built_in">make</span>([]worker, <span class="number">0</span>, size),</span><br><span class="line">		size:       size,</span><br><span class="line">		isPreAlloc: preAlloc,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 獲取 Queue 長度，因為是 Loop Queue，所以會有 head 指標 &gt; tail 指標的情況很正常</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(wq *circularQueue)</span> <span class="title">len</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="comment">// size == 0 || 頭尾一樣卻沒滿</span></span><br><span class="line">	<span class="keyword">if</span> wq.size == <span class="number">0</span> || wq.isEmpty() &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 頭尾一樣滿了</span></span><br><span class="line">	<span class="keyword">if</span> wq.head == wq.tail &amp;&amp; wq.isFull &#123;</span><br><span class="line">		<span class="keyword">return</span> wq.size</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> wq.tail &gt; wq.head &#123;</span><br><span class="line">		<span class="keyword">return</span> wq.tail - wq.head</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> wq.size - wq.head + wq.tail</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判斷 Queue 是否為空</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(wq *circularQueue)</span> <span class="title">isEmpty</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> wq.head == wq.tail &amp;&amp; !wq.isFull</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 插入一個 worker 進入 Queue</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(wq *circularQueue)</span> <span class="title">insert</span><span class="params">(w worker)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// Pool 已經被關閉</span></span><br><span class="line">	<span class="keyword">if</span> wq.size == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> errQueueIsReleased</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Pool 已經滿了</span></span><br><span class="line">	<span class="keyword">if</span> wq.isFull &#123;</span><br><span class="line">		<span class="keyword">return</span> errQueueIsFull</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 增加 Worker</span></span><br><span class="line">	<span class="comment">// 如果</span></span><br><span class="line">	<span class="keyword">if</span> !wq.isPreAlloc &amp;&amp; <span class="built_in">cap</span>(wq.items) &lt; wq.size &#123;</span><br><span class="line">		wq.items = <span class="built_in">append</span>(wq.items, w)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		wq.items[wq.tail] = w</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 如果 tail == size，讓 tail 變 0</span></span><br><span class="line">	wq.tail = (wq.tail + <span class="number">1</span>) % wq.size</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 如果 tail == head 代表滿了</span></span><br><span class="line">	<span class="keyword">if</span> wq.tail == wq.head &#123;</span><br><span class="line">		wq.isFull = <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 從 Queue 獲取一個 worker</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(wq *circularQueue)</span> <span class="title">detach</span><span class="params">()</span> <span class="title">worker</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> wq.isEmpty() &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 獲取一個 Worker</span></span><br><span class="line">	w := wq.items[wq.head]</span><br><span class="line">	wq.items[wq.head] = <span class="literal">nil</span> <span class="comment">// 避免記憶體溢出</span></span><br><span class="line">	<span class="comment">// 如果 head == size，讓 head 變 0</span></span><br><span class="line">	wq.head = (wq.head + <span class="number">1</span>) % wq.size</span><br><span class="line"></span><br><span class="line">	wq.isFull = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> w</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重新整理 Queue，用於清理過期的 worker</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(wq *circularQueue)</span> <span class="title">refresh</span><span class="params">(duration time.Duration)</span> []<span class="title">worker</span></span> &#123;</span><br><span class="line">	expiryTime := time.Now().Add(-duration)</span><br><span class="line">	<span class="comment">// 獲取過期 worker 的 index</span></span><br><span class="line">	index := wq.binarySearch(expiryTime)</span><br><span class="line">	<span class="keyword">if</span> index == <span class="number">-1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	wq.expiry = wq.expiry[:<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> wq.head &lt;= index &#123;</span><br><span class="line">		<span class="comment">// 找出從"頭"到 "index" 的 worker，因為 FIFO 的關係，越前面的沒有被使用代表有一端時間未使用了</span></span><br><span class="line">		wq.expiry = <span class="built_in">append</span>(wq.expiry, wq.items[wq.head:index+<span class="number">1</span>]...)</span><br><span class="line">		<span class="keyword">for</span> i := wq.head; i &lt; index+<span class="number">1</span>; i++ &#123;</span><br><span class="line">			wq.items[i] = <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// E.g. size = 10, tail = 5, head = 8 的狀態</span></span><br><span class="line">		<span class="comment">// 假設 index 是 3，那麼 8~9 和 0~3 的 worker 都要被清理，剩下 index 為 4, 5 的 worker</span></span><br><span class="line">		wq.expiry = <span class="built_in">append</span>(wq.expiry, wq.items[<span class="number">0</span>:index+<span class="number">1</span>]...)</span><br><span class="line">		wq.expiry = <span class="built_in">append</span>(wq.expiry, wq.items[wq.head:]...)</span><br><span class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; index+<span class="number">1</span>; i++ &#123;</span><br><span class="line">			wq.items[i] = <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> i := wq.head; i &lt; wq.size; i++ &#123;</span><br><span class="line">			wq.items[i] = <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 清理過後，重新分配 head</span></span><br><span class="line">	head := (index + <span class="number">1</span>) % wq.size</span><br><span class="line">	wq.head = head</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(wq.expiry) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		wq.isFull = <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 返回這些過期 worker 要讓 pool 去手動 finish 它</span></span><br><span class="line">	<span class="keyword">return</span> wq.expiry</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 二元搜尋，找出過期的 worker</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(wq *circularQueue)</span> <span class="title">binarySearch</span><span class="params">(expiryTime time.Time)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> mid, nlen, basel, tmid <span class="keyword">int</span></span><br><span class="line">	nlen = <span class="built_in">len</span>(wq.items)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// if no need to remove work, return -1</span></span><br><span class="line">	<span class="keyword">if</span> wq.isEmpty() || expiryTime.Before(wq.items[wq.head].getLastUpdatedTime()) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// example</span></span><br><span class="line">	<span class="comment">// size = 8, head = 7, tail = 4</span></span><br><span class="line">	<span class="comment">// [ 2, 3, 4, 5, nil, nil, nil,  1]  true position</span></span><br><span class="line">	<span class="comment">//   0  1  2  3    4   5     6   7</span></span><br><span class="line">	<span class="comment">//              tail          head</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">//   1  2  3  4  nil nil   nil   0   mapped position</span></span><br><span class="line">	<span class="comment">//            r                  l</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// base algorithm is a copy from worker_stack</span></span><br><span class="line">	<span class="comment">// map head and tail to effective left and right</span></span><br><span class="line">	r := (wq.tail - <span class="number">1</span> - wq.head + nlen) % nlen</span><br><span class="line">	basel = wq.head</span><br><span class="line">	l := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> l &lt;= r &#123;</span><br><span class="line">		mid = l + ((r - l) &gt;&gt; <span class="number">1</span>)</span><br><span class="line">		<span class="comment">// calculate true mid position from mapped mid position</span></span><br><span class="line">		tmid = (mid + basel + nlen) % nlen</span><br><span class="line">		<span class="keyword">if</span> expiryTime.Before(wq.items[tmid].getLastUpdatedTime()) &#123;</span><br><span class="line">			r = mid - <span class="number">1</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			l = mid + <span class="number">1</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// return true position from mapped position</span></span><br><span class="line">	<span class="keyword">return</span> (r + basel + nlen) % nlen</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 當 Pool 被 Release 後，就會觸發此方法，將所有 Worker queue 清理</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(wq *circularQueue)</span> <span class="title">reset</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> wq.isEmpty() &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 逐一把 goroutin 解決</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> w := wq.detach(); w != <span class="literal">nil</span> &#123;</span><br><span class="line">			w.finish()</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	wq.items = wq.items[:<span class="number">0</span>]</span><br><span class="line">	wq.expiry = wq.expiry[:<span class="number">0</span>]</span><br><span class="line">	wq.size = <span class="number">0</span></span><br><span class="line">	wq.head = <span class="number">0</span></span><br><span class="line">	wq.tail = <span class="number">0</span></span><br><span class="line">	wq.isFull = <span class="literal">false</span></span><br><span class="line">	wq.isPreAlloc = <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Benchmark"><a href="#Benchmark" class="headerlink" title="Benchmark"></a>Benchmark</h2><h3 id="10萬個任務，10萬個-worker"><a href="#10萬個任務，10萬個-worker" class="headerlink" title="10萬個任務，10萬個 worker"></a>10萬個任務，10萬個 worker</h3><p><img src="/images/Build-A-Goroutine-Pool/100000_100000.png" alt=""></p>
<h3 id="100萬個任務，10萬個-worker"><a href="#100萬個任務，10萬個-worker" class="headerlink" title="100萬個任務，10萬個 worker"></a>100萬個任務，10萬個 worker</h3><p><img src="/images/Build-A-Goroutine-Pool/1000000_100000.png" alt=""></p>
<h3 id="1000萬個任務，10萬個-worker"><a href="#1000萬個任務，10萬個-worker" class="headerlink" title="1000萬個任務，10萬個 worker"></a>1000萬個任務，10萬個 worker</h3><p><img src="/images/Build-A-Goroutine-Pool/10000000_100000.png" alt=""></p>
<h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>本篇文章是參考<span class="exturl" data-url="aHR0cHM6Ly9zdHJpa2VmcmVlZG9tLnRvcC9hcmNoaXZlcy9oaWdoLXBlcmZvcm1hbmNlLWltcGxlbWVudGF0aW9uLW9mLWdvcm91dGluZS1wb29sI3RvYy1oZWFkLTMx">潘少 - GMP 并发调度器深度解析之手撸一个高性能 goroutine pool<i class="fa fa-external-link-alt"></i></span> 和 <span class="exturl" data-url="aHR0cHM6Ly9tZWRpdW0uY29tLzE3bGl2ZS10ZWNoLyVFOSU4MiVBMyVFNCVCQSU5QiVFNSVCOSVCNCVFNiU4OCU5MSVFNSU4MCU5MSVFOCVCRiVCRCVFNyU5QSU4NC1nb3JvdXRpbmUtcG9vbC1lOGQyMTE3NTdlZQ==">Viney Tai-Li Shih - 那些年我們追的 Goroutine Pool<i class="fa fa-external-link-alt"></i></span> 進而實現的 goroutine pool，通過 <code>限制 goroutines 數量</code>、 <code>重複使用 goroutines</code> 來達到效能的提升。</p>
<p>其中，我將一般的 <code>stack</code> 方式改成使用 <code>circular queue</code> 進而避免陣列中不斷對記憶體申請產生損耗，在大量任務要執行的時候有產生一定的作用。</p>
<p>在 benchmark 中，同等 worker 處理同等任務時可以獲得更快處理時間(<code>20%</code>)、更少的記憶體使用空間(<code>1000%</code>)，但是當任務數量大於 worker 數量時，處理時間就會開始變慢(<code>-30%</code>)，記憶體人仍然保持著一定的優勢。或許，變慢可能是我在設計的時候處理鎖處理的不適很恰當的原因。</p>
<blockquote>
<p>本文範例程式碼在 GitHub 上的 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1BPQUJPQi9ncnBvb2w=">POABOB/grpool<i class="fa fa-external-link-alt"></i></span>。</p>
</blockquote>
<h2 id="參考文獻"><a href="#參考文獻" class="headerlink" title="參考文獻"></a>參考文獻</h2><ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9zdHJpa2VmcmVlZG9tLnRvcC9hcmNoaXZlcy9oaWdoLXBlcmZvcm1hbmNlLWltcGxlbWVudGF0aW9uLW9mLWdvcm91dGluZS1wb29sI3RvYy1oZWFkLTE4">https://strikefreedom.top/archives/high-performance-implementation-of-goroutine-pool#toc-head-18<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3BhbmpmMjAwMC9hbnRz">https://github.com/panjf2000/ants<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xOTE4MjM2">https://cloud.tencent.com/developer/article/1918236<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cucmVhZGZvZy5jb20vYS8xNjMxMjg3MTg2NDk4MzU5Mjk2">https://www.readfog.com/a/1631287186498359296<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9tZWRpdW0uY29tLzE3bGl2ZS10ZWNoLyVFOSU4MiVBMyVFNCVCQSU5QiVFNSVCOSVCNCVFNiU4OCU5MSVFNSU4MCU5MSVFOCVCRiVCRCVFNyU5QSU4NC1nb3JvdXRpbmUtcG9vbC1lOGQyMTE3NTdlZQ==">https://medium.com/17live-tech/%E9%82%A3%E4%BA%9B%E5%B9%B4%E6%88%91%E5%80%91%E8%BF%BD%E7%9A%84-goroutine-pool-e8d211757ee<i class="fa fa-external-link-alt"></i></span></li>
</ul>

    </div>

    
    
    
        <div>
        
            <div style="text-align:center;color: #ccc;font-size:14px;">------ 本文結束 ------</div>
        
        </div>
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>作者： </strong>POABOB
  </li>
  <li class="post-copyright-link">
    <strong>文章連結：</strong>
    <a href="https://poabob.github.io/2023-09-15/Build-A-Goroutine-Pool/" title="如何實作 Goroutine Pool?">https://poabob.github.io/2023-09-15/Build-A-Goroutine-Pool/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版權聲明： </strong>本網誌所有文章除特別聲明外，均採用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC96aC1UVw=="><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</span> 許可協議。轉載請註明出處！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/goroutine/" rel="tag"># goroutine</a>
              <a href="/tags/goroutine-pool/" rel="tag"># goroutine-pool</a>
              <a href="/tags/golang/" rel="tag"># golang</a>
              <a href="/tags/go/" rel="tag"># go</a>
              <a href="/tags/Backend/" rel="tag"># Backend</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023-01-31/The-Best-Way-of-Building-A-Smallest-Docker-Image-on-Production-Environment-Using-Golang/" rel="prev" title="Golang 最佳化打包 Docker Image 至上線環境">
      <i class="fa fa-chevron-left"></i> Golang 最佳化打包 Docker Image 至上線環境
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

  <div id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>


        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Goroutine-Pool"><span class="nav-number">1.</span> <span class="nav-text">Goroutine Pool</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#介紹"><span class="nav-number">1.2.</span> <span class="nav-text">介紹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#設計思路"><span class="nav-number">1.3.</span> <span class="nav-text">設計思路</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Goroutine-Pool-實作"><span class="nav-number">1.4.</span> <span class="nav-text">Goroutine Pool 實作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#定義-Pool-struct"><span class="nav-number">1.4.1.</span> <span class="nav-text">定義 Pool struct</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#定義-Options，客製化額外需求"><span class="nav-number">1.4.2.</span> <span class="nav-text">定義 Options，客製化額外需求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化-Pool，加載-Options-並開啟自動清理"><span class="nav-number">1.4.3.</span> <span class="nav-text">初始化 Pool，加載 Options 並開啟自動清理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#定時清理過期的-Worker"><span class="nav-number">1.4.4.</span> <span class="nav-text">定時清理過期的 Worker</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pool-的基本操作，Pool-的狀態操作"><span class="nav-number">1.4.5.</span> <span class="nav-text">Pool 的基本操作，Pool 的狀態操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pool-執行任務"><span class="nav-number">1.4.6.</span> <span class="nav-text">Pool 執行任務</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pool-獲取-放回-Worker"><span class="nav-number">1.4.7.</span> <span class="nav-text">Pool 獲取&#x2F;放回 Worker</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pool-關閉與開啟"><span class="nav-number">1.4.8.</span> <span class="nav-text">Pool 關閉與開啟</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Worker-的定義"><span class="nav-number">1.4.9.</span> <span class="nav-text">Worker 的定義</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Worker-Queue-的實現"><span class="nav-number">1.4.10.</span> <span class="nav-text">Worker Queue 的實現</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Benchmark"><span class="nav-number">1.5.</span> <span class="nav-text">Benchmark</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10萬個任務，10萬個-worker"><span class="nav-number">1.5.1.</span> <span class="nav-text">10萬個任務，10萬個 worker</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#100萬個任務，10萬個-worker"><span class="nav-number">1.5.2.</span> <span class="nav-text">100萬個任務，10萬個 worker</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1000萬個任務，10萬個-worker"><span class="nav-number">1.5.3.</span> <span class="nav-text">1000萬個任務，10萬個 worker</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#結論"><span class="nav-number">1.6.</span> <span class="nav-text">結論</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#參考文獻"><span class="nav-number">1.7.</span> <span class="nav-text">參考文獻</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="POABOB"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">POABOB</p>
  <div class="site-description" itemprop="description">Life is but a span!</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">9</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分類</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">35</span>
        <span class="site-state-item-name">標籤</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1BPQUJPQg==" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;POABOB"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOnp4Yzc1MjE2NkBnbWFpbC5jb20=" title="E-Mail → mailto:zxc752166@gmail.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly93d3cuZmFjZWJvb2suY29tL3Byb2ZpbGUucGhwP2lkPTEwMDAwMDMyMTQwMDU5MA==" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;profile.php?id&#x3D;100000321400590"><i class="fab fa-facebook fa-fw"></i>FB Page</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9pbnN0YWdyYW0uY29tLzB4N2YyZWI=" title="Instagram → https:&#x2F;&#x2F;instagram.com&#x2F;0x7f2eb"><i class="fab fa-instagram fa-fw"></i>Instagram</span>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">POABOB</span>
</div>
  <div class="powered-by">由 <span class="exturl theme-link" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl theme-link" data-url="aHR0cHM6Ly9waXNjZXMudGhlbWUtbmV4dC5vcmc=">NexT.Pisces</span> 強力驅動
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  




  
<script src="/js/local-search.js"></script>















    <div id="pjax">
  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">
<script src="https://gist.githubusercontent.com/POABOB/65b37ccc358df67efffeedf571219b2a/raw/b26f8f05e0951aa1c22d11122f3232b986012141/md5.min.js"></script>
<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '5aa580a2136b90e75fd6',
      clientSecret: '128f00ea948ebd5cb1c0c2c7c3a2b81f067257ea',
      repo        : 'poabob.github.io',
      owner       : 'POABOB',
      admin       : ['POABOB'],
      id          : '3995fc5c8b39daf435cb47372fda769b',
        language: 'en | es-ES | fr | ru | zh-CN | zh-TW',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

    </div>
</body>
</html>
