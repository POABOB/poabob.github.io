<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="google-site-verification" content="gMiqErWj487BTNydQ4JwPWMijWfHq7w5bqkaC5JPH9c">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"poabob.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":true,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="前言 藉由 基礎篇 所提供的簡單範例，我們可以發現如果我們把每個路由都寫成一個閉包(Closure)的形式，很容易導致程式碼不易閱讀，並且把所有資料都寫在一個檔案非常難以去釐清 RESTful API 服務的類型和相關的依賴類。 所以本篇將要介紹如何將 SLIM 4 構建成一個屬於 ADR 模式的一個框架，構建之前也會介紹傳統 MVC 框架的架構，之後再來講解如何使用 JWT 如何用作登入後產生">
<meta property="og:type" content="article">
<meta property="og:title" content="使用 PHP Slim 4 建立一個 RESTful 框架 (進階篇)">
<meta property="og:url" content="https://poabob.github.io/2022-09-02/Build-a-PHP-RESTful-Framework-using-Slim-4-Part2/index.html">
<meta property="og:site_name" content="POABOB">
<meta property="og:description" content="前言 藉由 基礎篇 所提供的簡單範例，我們可以發現如果我們把每個路由都寫成一個閉包(Closure)的形式，很容易導致程式碼不易閱讀，並且把所有資料都寫在一個檔案非常難以去釐清 RESTful API 服務的類型和相關的依賴類。 所以本篇將要介紹如何將 SLIM 4 構建成一個屬於 ADR 模式的一個框架，構建之前也會介紹傳統 MVC 框架的架構，之後再來講解如何使用 JWT 如何用作登入後產生">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://poabob.github.io/images/Build-a-PHP-RESTful-Framework-using-Slim-4-Part2/mvc.png">
<meta property="og:image" content="https://poabob.github.io/images/Build-a-PHP-RESTful-Framework-using-Slim-4-Part2/adr.png">
<meta property="og:image" content="https://poabob.github.io/images/Build-a-PHP-RESTful-Framework-using-Slim-4-Part2/1.jpg">
<meta property="og:image" content="https://poabob.github.io/images/Build-a-PHP-RESTful-Framework-using-Slim-4-Part2/2.jpg">
<meta property="og:image" content="https://poabob.github.io/images/Build-a-PHP-RESTful-Framework-using-Slim-4-Part2/3.jpg">
<meta property="og:image" content="https://poabob.github.io/images/Build-a-PHP-RESTful-Framework-using-Slim-4-Part2/jwt.png">
<meta property="og:image" content="https://poabob.github.io/images/Build-a-PHP-RESTful-Framework-using-Slim-4-Part2/4.jpg">
<meta property="og:image" content="https://poabob.github.io/images/Build-a-PHP-RESTful-Framework-using-Slim-4-Part2/5.jpg">
<meta property="og:image" content="https://poabob.github.io/images/Build-a-PHP-RESTful-Framework-using-Slim-4-Part2/6.jpg">
<meta property="article:published_time" content="2022-09-02T03:18:43.000Z">
<meta property="article:modified_time" content="2022-09-28T18:03:23.381Z">
<meta property="article:author" content="POABOB">
<meta property="article:tag" content="Swagger-ui">
<meta property="article:tag" content="PHP">
<meta property="article:tag" content="Slim 4">
<meta property="article:tag" content="RESTful">
<meta property="article:tag" content="Jwt">
<meta property="article:tag" content="Docker">
<meta property="article:tag" content="PSR-7">
<meta property="article:tag" content="PSR-11">
<meta property="article:tag" content="PSR-15">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://poabob.github.io/images/Build-a-PHP-RESTful-Framework-using-Slim-4-Part2/mvc.png">

<link rel="canonical" href="https://poabob.github.io/2022-09-02/Build-a-PHP-RESTful-Framework-using-Slim-4-Part2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-TW'
  };
</script>

  <title>使用 PHP Slim 4 建立一個 RESTful 框架 (進階篇) | POABOB</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-162792341-1"></script>
    <script data-pjax>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-162792341-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">POABOB</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">小小工程師的筆記分享</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首頁</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>標籤</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分類</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>歸檔</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜尋..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://poabob.github.io/2022-09-02/Build-a-PHP-RESTful-Framework-using-Slim-4-Part2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="POABOB">
      <meta itemprop="description" content="Life is but a span!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="POABOB">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          使用 PHP Slim 4 建立一個 RESTful 框架 (進階篇)
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2022-09-02 11:18:43" itemprop="dateCreated datePublished" datetime="2022-09-02T11:18:43+08:00">2022-09-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2022-09-29 02:03:23" itemprop="dateModified" datetime="2022-09-29T02:03:23+08:00">2022-09-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BE%8C%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">後端</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p>藉由 <a href="https://poabob.github.io/2022-07-28/Build-a-PHP-RESTful-Framework-using-Slim-4-Part1/">基礎篇</a> 所提供的簡單範例，我們可以發現如果我們把每個路由都寫成一個<code>閉包(Closure)</code>的形式，很容易導致程式碼<code>不易閱讀</code>，並且把所有資料都寫在一個檔案非常難以去釐清 RESTful API <code>服務的類型</code>和<code>相關的依賴類</code>。</p>
<p>所以本篇將要介紹如何將 SLIM 4 構建成一個屬於 <code>ADR 模式</code>的一個框架，構建之前也會介紹傳統 <code>MVC 框架</code>的架構，之後再來講解如何使用 <code>JWT</code> 如何用作<code>登入後產生 Token</code> 並且<code>驗證其身份資訊</code>。</p>
</blockquote>
<a id="more"></a> 

<ul>
<li>以下我構想這個框架要符合什麼條件:<ol>
<li>基於 ADR 模式</li>
<li>要有一個基礎的 ORM(可以不用 Migration)</li>
<li>要有 Jwt 功能</li>
<li>能夠輕鬆寫單元測試、E2E 測試</li>
<li>要使用 Docker 一鍵啟動</li>
<li>使用 Github Actions CI / CD</li>
</ol>
</li>
</ul>
<ul>
<li>本篇主要是參考 <span class="exturl" data-url="aHR0cHM6Ly93d3cuZHJzYW53dWppYW5nLmNvbQ==">Fogless<i class="fa fa-external-link-alt"></i></span> 的<span class="exturl" data-url="aHR0cHM6Ly93d3cuZHJzYW53dWppYW5nLmNvbS9zbGltNC1idWlsZC1yZXN0ZnVsLWFwaS8jY3JlYXRlLXNsaW0tYXBwbGljYXRpb24=">Slim 4 搭建 RESTful API<i class="fa fa-external-link-alt"></i></span> 以及 <span class="exturl" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9kb3BpdHo=">Daniel Opitz<i class="fa fa-external-link-alt"></i></span> 的<span class="exturl" data-url="aHR0cHM6Ly9vZGFuLmdpdGh1Yi5pby8yMDE5LzExLzA1L3NsaW00LXR1dG9yaWFsLmh0bWw=">Slim 4 - Tutorial<i class="fa fa-external-link-alt"></i></span>，並且結合自身所學，再根據個人習慣建構。進階篇的建構方向是藉由基礎篇的基礎，將 Slim 4 的 <code>ADR 框架</code>建立完成，並且實現 <code>表單驗證</code>、<code>統一回應格式</code>、<code>Jwt</code>、<code>登入登出</code>功能。</li>
</ul>
<h2 id="安裝"><a href="#安裝" class="headerlink" title="安裝"></a>安裝</h2><h3 id="本機最低需求"><a href="#本機最低需求" class="headerlink" title="本機最低需求"></a>本機最低需求</h3><ul>
<li>PHP 8.0 (目前沒有使用 php-7.4 實測過，所以希望至少可以 8.0 以上)</li>
<li>Composer</li>
<li>Docker、Docker-Compose<ul>
<li>Nginx </li>
<li>PHP 8.1</li>
<li>MariaDB</li>
</ul>
</li>
</ul>
<h3 id="安裝相關依賴"><a href="#安裝相關依賴" class="headerlink" title="安裝相關依賴"></a>安裝相關依賴</h3><ul>
<li>我們先將基礎篇的範例程式碼 <code>clone</code> 下來命名成新專案 <code>Slim-ADR</code>，然後將相關依賴先安裝。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># clone 基礎篇專案</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/POABOB/Slim-Simple.git</span><br><span class="line"><span class="comment"># 重新命名</span></span><br><span class="line">mv Slim-Simple Slim-ADR</span><br><span class="line"><span class="comment"># 安裝相關依賴</span></span><br><span class="line">composer install</span><br><span class="line"><span class="comment"># 將 .env.example 改名 .env</span></span><br><span class="line">mv .env.example .env</span><br></pre></td></tr></table></figure>

<h2 id="建構-RESTful-API"><a href="#建構-RESTful-API" class="headerlink" title="建構 RESTful API"></a>建構 RESTful API</h2><h3 id="PSR-4"><a href="#PSR-4" class="headerlink" title="PSR-4"></a>PSR-4</h3><ul>
<li><code>PSR-4 Autoloader</code> 是用來告訴開發者如何架構專案的<code>目錄結構</code>及<code>命名空間</code>，遵循這個規範並搭配 Composer 提供的 <code>autoload</code> 的功能，就可以<code>將 PHP 檔案進行自動加載</code>，而不用一直使用 <code>require</code>。</li>
<li>我們要自動加載的目錄為 <code>src</code>、<code>tests</code> (請順便建立)，<code>src</code> 目錄是用來存放我們 RESRful API的程式碼，<code>tests</code> 則是我們用來撰寫軟體測試時所用的目錄。</li>
<li>當我們把 <code>autoload</code> 的<code>位置</code>和<code>命名變數</code>設定好之後，完整檔案應該如下呈現：</li>
</ul>
<p><code>composer.json</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"poabob/slim-adr"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"project"</span>,</span><br><span class="line">    <span class="attr">"description"</span>: <span class="string">"A Simple Restful PHP Microservice Framework!"</span>,</span><br><span class="line">    <span class="attr">"homepage"</span>: <span class="string">"https://github.com/POABOB/Slim-ADR"</span>,</span><br><span class="line">    <span class="attr">"authors"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"POABOB"</span>,</span><br><span class="line">            <span class="attr">"email"</span>: <span class="string">"zxc752166@gmail.com"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"keywords"</span>: [</span><br><span class="line">        <span class="string">"slim-simple"</span>,</span><br><span class="line">        <span class="string">"slim"</span>,</span><br><span class="line">        <span class="string">"slim4"</span>,</span><br><span class="line">        <span class="string">"slim-4"</span>,</span><br><span class="line">        <span class="string">"nginx"</span>,</span><br><span class="line">        <span class="string">"microservice"</span>,</span><br><span class="line">        <span class="string">"restful"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"license"</span>: <span class="string">"MIT"</span>,</span><br><span class="line">    <span class="attr">"require"</span>: &#123;</span><br><span class="line">        <span class="attr">"php"</span>: <span class="string">"&gt;=8.0"</span>,</span><br><span class="line">        <span class="attr">"catfan/medoo"</span>: <span class="string">"^2.1"</span>,</span><br><span class="line">        <span class="attr">"php-di/php-di"</span>: <span class="string">"^6.4"</span>,</span><br><span class="line">        <span class="attr">"selective/basepath"</span>: <span class="string">"^2.1"</span>,</span><br><span class="line">        <span class="attr">"slim/http"</span>: <span class="string">"^1.0"</span>,</span><br><span class="line">        <span class="attr">"slim/psr7"</span>: <span class="string">"^1.0"</span>,</span><br><span class="line">        <span class="attr">"slim/slim"</span>: <span class="string">"^4.10"</span>,</span><br><span class="line">        <span class="attr">"symfony/dotenv"</span>: <span class="string">"^6.0"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"config"</span>: &#123;</span><br><span class="line">        <span class="attr">"process-timeout"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"sort-packages"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"autoload"</span>: &#123;</span><br><span class="line">        <span class="attr">"psr-4"</span>: &#123;</span><br><span class="line">            <span class="attr">"App\\"</span>: <span class="string">"src"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"autoload-dev"</span>: &#123;</span><br><span class="line">        <span class="attr">"psr-4"</span>: &#123;</span><br><span class="line">            <span class="attr">"App\\Test\\"</span>: <span class="string">"tests"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="MVC-模式"><a href="#MVC-模式" class="headerlink" title="MVC 模式"></a>MVC 模式</h3><ul>
<li>什麼是 <code>MVC</code> 呢?我們可以先由以下流程圖來了解 <code>MVC</code> 的運作模式。</li>
</ul>
<p><img src="/images/Build-a-PHP-RESTful-Framework-using-Slim-4-Part2/mvc.png" alt="mvc"></p>
<ol>
<li>每當我們 <code>Client</code> 向 <code>Server</code> 傳遞請求的時候，首先會被先由<code>路由(Route)</code>來去攔截，攔截這份請求解析他的 <code>HTTP Method</code> 和 <code>URI</code>。</li>
<li>路由找到對應的<code>控制器(Controller)</code>，一個控制器通常會有多個類型相同的 <code>Action</code> 操作。</li>
<li>去執行該控制器的 <code>Action</code> 處理我們想要做的事情，這裡通常會做一些<code>業務邏輯</code>、<code>表單驗證</code>的事情。</li>
<li>如果該 <code>Action</code> 會使用到資料庫的話，控制器不能執行資料庫操作，而是要讓 <code>Model</code> 來去做 DB 的 <code>CRUD</code>。</li>
<li><code>Model</code> 將會與資料庫建立連線，並且把 SQL 語法當作溝通工具與資料庫溝通。</li>
<li>從資料庫操作完我們要做的事情後，返回結果給 <code>Model</code>。</li>
<li><code>Model</code> 將結果返回給<code>控制器</code>，這邊可以做<code>資料相關的處理</code>。</li>
<li><code>控制器</code>將我們所拿到的資料或結果渲染在 <code>View</code> 當中。</li>
<li>最後把 <code>View</code> 的渲染結果返回給 <code>Client</code>。</li>
</ol>
<ul>
<li>MVC 結論</li>
</ul>
<table>
<thead>
<tr>
<th>名稱</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>Controller</td>
<td>檢查請求的資料<code>是否符合規範</code>、<code>業務處理</code>、資料庫返回<code>資料的格式處理</code>、連接 <code>Model</code> 和 <code>View</code> 的主幹</td>
</tr>
<tr>
<td>Model</td>
<td><code>資料庫溝通</code></td>
</tr>
<tr>
<td>View</td>
<td>將結果<code>渲染</code>到我們的視圖給 Client</td>
</tr>
</tbody></table>
<h3 id="ADR-模式"><a href="#ADR-模式" class="headerlink" title="ADR 模式"></a>ADR 模式</h3><ul>
<li>我們可以看到 <code>MVC</code> 雖然是一個非常完整且成熟的架構，但依然看得到幾樣缺點。<ol>
<li><code>Controller</code> 負載的工作量太大，寫久了容易導致 <code>Controller</code> 裡面的 <code>Action</code> 複雜且難以閱讀。</li>
<li>現行比較流行前後端分離的架構(SPA)，導致 <code>View</code> 在 <code>RESTful API</code> 中沒有什麼存在的必要性。</li>
</ol>
</li>
<li>因此，進而產生了 <code>ADR</code>(Action - Domain - Responder)這個模式，<code>Action</code> 主要是將 <code>Controller</code> 中的 <code>Action</code> 獨立出來成一個單獨的檔案，一個 <code>Action</code> 就<code>只負責一件事情</code>，並且他只處理<code>請求</code>和<code>回應</code>兩項操作。<code>Domain</code> 則包含了兩種操作，一個是 <code>Service</code>，另外一個則是 <code>Repository</code>。基本上一個 <code>Action</code> 會對應一個獨立的 <code>Service</code>，而 <code>Service</code> 就是用來切割原本在 <code>Controller</code> 大量的工作。<code>Repository</code> 則是與原先 <code>Model</code> 非常類似並且裡面會有多種資料庫操作。</li>
</ul>
<p><img src="/images/Build-a-PHP-RESTful-Framework-using-Slim-4-Part2/adr.png" alt="adr"></p>
<ul>
<li>ADR 結論</li>
</ul>
<table>
<thead>
<tr>
<th>名稱</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>Action</td>
<td>負責處理<code>請求</code>和<code>回應</code></td>
</tr>
<tr>
<td>Service</td>
<td>檢查請求的資料<code>是否符合規範</code>、<code>業務處理</code>、資料庫返回<code>資料的格式處理</code></td>
</tr>
<tr>
<td>Repository</td>
<td><code>資料庫溝通</code></td>
</tr>
</tbody></table>
<h3 id="Action"><a href="#Action" class="headerlink" title="Action"></a>Action</h3><ul>
<li>我們先 <code>src</code> 目錄之中建立一個 <code>Action</code>目錄。</li>
<li>並且在 <code>src/Action</code> 建立一個專門給 <code>Users</code> 的資料夾 <code>src/Action/Users</code>。</li>
<li>然後建立四個檔案，分別是 <code>src/Action/Users/GetAction.php</code>、<code>src/Action/Users/InsertAction.php</code>、<code>src/Action/Users/UpdateAction.php</code>、<code>src/Action/Users/DeleteAction.php</code>。</li>
<li>目錄大概會如下圖：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── src/ </span><br><span class="line">|   ├── Actions/</span><br><span class="line">|   |   └── Users/</span><br><span class="line">|   |       ├── GetAction.php</span><br><span class="line">|   |       ├── InsertAction.php</span><br><span class="line">|   |       ├── UpdateAction.php</span><br><span class="line">|   |       └── DeleteAction.php</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><code>src/Action/Users/GetAction.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Action</span>\<span class="title">Users</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">use</span> <span class="title">Slim</span>\<span class="title">Http</span>\<span class="title">Response</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Psr</span>\<span class="title">Http</span>\<span class="title">Message</span>\<span class="title">ServerRequestInterface</span> <span class="title">as</span> <span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Domain</span>\<span class="title">Users</span>\<span class="title">Service</span>\<span class="title">GetService</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GetAction</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="keyword">private</span> GetService $service;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(GetService $service)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;service = $service;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">(Request $request, Response $response)</span>: <span class="title">Response</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="comment">// 請求 Service</span></span><br><span class="line">    $return = <span class="keyword">$this</span>-&gt;service-&gt;getUsers();</span><br><span class="line">    <span class="keyword">return</span> $response-&gt;withJson($return, <span class="number">200</span>, JSON_UNESCAPED_UNICODE);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>src/Action/Users/InsertAction.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Action</span>\<span class="title">Users</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">use</span> <span class="title">Slim</span>\<span class="title">Http</span>\<span class="title">Response</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Psr</span>\<span class="title">Http</span>\<span class="title">Message</span>\<span class="title">ServerRequestInterface</span> <span class="title">as</span> <span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Domain</span>\<span class="title">Users</span>\<span class="title">Service</span>\<span class="title">InsertService</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">InsertAction</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="keyword">private</span> InsertService $service;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(InsertService $service)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;service = $service;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">(Request $request, Response $response)</span>: <span class="title">Response</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="comment">// 獲取請求的Body</span></span><br><span class="line">    $data = (<span class="keyword">array</span>)$request-&gt;getParsedBody();</span><br><span class="line">    $return = <span class="keyword">$this</span>-&gt;service-&gt;insertUser($data);</span><br><span class="line">    <span class="keyword">return</span> $response-&gt;withJson($return, <span class="number">200</span>, JSON_UNESCAPED_UNICODE);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>src/Action/Users/UpdateAction.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Action</span>\<span class="title">Users</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">use</span> <span class="title">Slim</span>\<span class="title">Http</span>\<span class="title">Response</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Psr</span>\<span class="title">Http</span>\<span class="title">Message</span>\<span class="title">ServerRequestInterface</span> <span class="title">as</span> <span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Domain</span>\<span class="title">Users</span>\<span class="title">Service</span>\<span class="title">UpdateService</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">UpdateAction</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="keyword">private</span> UpdateService $service;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(UpdateService $service)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;service = $service;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">(Request $request, Response $response)</span>: <span class="title">Response</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="comment">// 獲取請求的Body</span></span><br><span class="line">    $data = (<span class="keyword">array</span>)$request-&gt;getParsedBody();</span><br><span class="line">    $return = <span class="keyword">$this</span>-&gt;service-&gt;updateUser($data);</span><br><span class="line">    <span class="keyword">return</span> $response-&gt;withJson($return, <span class="number">200</span>, JSON_UNESCAPED_UNICODE);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>src/Action/Users/DeleteAction.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Action</span>\<span class="title">Users</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">use</span> <span class="title">Slim</span>\<span class="title">Http</span>\<span class="title">Response</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Psr</span>\<span class="title">Http</span>\<span class="title">Message</span>\<span class="title">ServerRequestInterface</span> <span class="title">as</span> <span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Domain</span>\<span class="title">Users</span>\<span class="title">Service</span>\<span class="title">DeleteService</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DeleteAction</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="keyword">private</span> DeleteService $service;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(DeleteService $service)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;service = $service;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">(Request $request, Response $response)</span>: <span class="title">Response</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="comment">// 獲取請求的Body</span></span><br><span class="line">    $data = (<span class="keyword">array</span>)$request-&gt;getParsedBody();</span><br><span class="line">    $return = <span class="keyword">$this</span>-&gt;service-&gt;deleteUser($data);</span><br><span class="line">    <span class="keyword">return</span> $response-&gt;withJson($return, <span class="number">200</span>, JSON_UNESCAPED_UNICODE);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><ul>
<li>在我們上方的四個 <code>Action</code> 可以看到，每個 <code>Action</code> 都向一個獨立的 <code>Service</code> 請求結果，並且將結果返回。</li>
<li>那我們可以建立 <code>src/Domain/Users/Service</code> 和 <code>src/Domain/Users/Repository</code> 兩種路徑目錄當作我們 <code>Users</code> 的 <code>Domain</code>。</li>
<li>然後在目錄中建立四個檔案，分別是 <code>src/Domain/Users/Service/GetService.php</code>、<code>src/Domain/Users/Service/InsertService.php</code>、<code>src/Domain/Users/Service/UpdateService.php</code>、<code>src/Domain/Users/Service/DeleteService.php</code>。</li>
<li>目錄大概會如下圖：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── src/ </span><br><span class="line">|   ├── Domain/     </span><br><span class="line">|   |   └── Users/</span><br><span class="line">|   |       ├── Repository/</span><br><span class="line">|   |       └── Service/</span><br><span class="line">|   |           ├── GetService.php</span><br><span class="line">|   |           ├── InsertService.php</span><br><span class="line">|   |           ├── UpdateService.php</span><br><span class="line">|   |           └── DeleteService.php</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><code>src/Domain/Users/Service/GetService.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Domain</span>\<span class="title">Users</span>\<span class="title">Service</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Domain</span>\<span class="title">Users</span>\<span class="title">Repository</span>\<span class="title">UsersRepository</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GetService</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="keyword">private</span> UsersRepository $db;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(UsersRepository $db)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;db = $db;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getUsers</span><span class="params">()</span>: <span class="title">array</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="comment">// 請求 Repository</span></span><br><span class="line">    $param = <span class="string">"*"</span>;</span><br><span class="line">    $where = <span class="number">1</span>;</span><br><span class="line">    $data = <span class="keyword">$this</span>-&gt;db-&gt;getUsers($param, $where);</span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>src/Domain/Users/Service/InsertService.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Domain</span>\<span class="title">Users</span>\<span class="title">Service</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Domain</span>\<span class="title">Users</span>\<span class="title">Repository</span>\<span class="title">UsersRepository</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">InsertService</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="keyword">private</span> UsersRepository $db;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(UsersRepository $db)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;db = $db;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">insertUser</span><span class="params">(array $data)</span>: <span class="title">int</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="comment">// 請求 Repository</span></span><br><span class="line">    $return = <span class="keyword">$this</span>-&gt;db-&gt;insertUser($data);</span><br><span class="line">    <span class="keyword">return</span> $return;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>src/Domain/Users/Service/UpdateService.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Domain</span>\<span class="title">Users</span>\<span class="title">Service</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Domain</span>\<span class="title">Users</span>\<span class="title">Repository</span>\<span class="title">UsersRepository</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">UpdateService</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="keyword">private</span> UsersRepository $db;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(UsersRepository $db)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;db = $db;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">updateUser</span><span class="params">(array $data)</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="comment">// 請求 Repository</span></span><br><span class="line">    $return = <span class="keyword">$this</span>-&gt;db-&gt;updateUser(</span><br><span class="line">      [<span class="string">"name"</span> =&gt; $data[<span class="string">"name"</span>]],</span><br><span class="line">      [<span class="string">"id"</span> =&gt; $data[<span class="string">"id"</span>]]</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> $return;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>src/Domain/Users/Service/DeleteService.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Domain</span>\<span class="title">Users</span>\<span class="title">Service</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Domain</span>\<span class="title">Users</span>\<span class="title">Repository</span>\<span class="title">UsersRepository</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DeleteService</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="keyword">private</span> UsersRepository $db;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(UsersRepository $db)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;db = $db;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">deleteUser</span><span class="params">(array $data)</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="comment">// 請求 Repository</span></span><br><span class="line">    $return = <span class="keyword">$this</span>-&gt;db-&gt;deleteUser([<span class="string">"id"</span> =&gt; $data[<span class="string">"id"</span>]]);</span><br><span class="line">    <span class="keyword">return</span> $return;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Repository"><a href="#Repository" class="headerlink" title="Repository"></a>Repository</h3><ul>
<li>每個 <code>Service</code> 都會統一向 <code>Repository</code> 請求資料庫操作。</li>
<li>我們在目錄中建立 <code>src/Domain/Users/Repository/UsersRepository.php</code> 讓我們操作資料庫。</li>
<li>目錄大概會如下圖：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── src/ </span><br><span class="line">|   ├── Domain/     </span><br><span class="line">|   |   └── Users/</span><br><span class="line">|   |       └── Repository/</span><br><span class="line">|   |           └── UsersRepository.php</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><code>src/Domain/Users/Repository/UsersRepository.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Domain</span>\<span class="title">Users</span>\<span class="title">Repository</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">UnexpectedValueException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Medoo</span>\<span class="title">Medoo</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UsersRepository</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">/** <span class="doctag">@var</span> Medoo $DB 連線 */</span></span><br><span class="line">  <span class="keyword">private</span> Medoo $db;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> Medoo $DB 連線</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Medoo $db)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;db = $db;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 獲取Users</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> array|string 欄位</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> array|int WHERE條件</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> string 表名</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getUsers</span><span class="params">(array | string $params = <span class="string">"*"</span>, array | int $where = <span class="number">1</span>, string $table = <span class="string">"Users"</span>)</span>: <span class="title">array</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;db-&gt;select($table, $params, $where);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PDOException $e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UnexpectedValueException($e-&gt;getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 插入User</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> array 欄位</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> string 表名</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">insertUser</span><span class="params">(array $params = [], string $table = <span class="string">"Users"</span>)</span>: <span class="title">int</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">$this</span>-&gt;db-&gt;insert($table, $params);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;db-&gt;id();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PDOException $e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UnexpectedValueException($e-&gt;getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 更新User</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> array 欄位</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> array WHERE條件</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> string 表名</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> int</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">updateUser</span><span class="params">(array $params = [], array $where = [], string $table = <span class="string">"Users"</span>)</span>: <span class="title">void</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">$this</span>-&gt;db-&gt;update($table, $params, $where);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PDOException $e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UnexpectedValueException($e-&gt;getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 刪除User</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> array WHERE條件</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> string 表名</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">deleteUser</span><span class="params">(array $where = [], string $table = <span class="string">"Users"</span>)</span>: <span class="title">void</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">$this</span>-&gt;db-&gt;delete($table, $where);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PDOException $e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UnexpectedValueException($e-&gt;getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h3><ul>
<li>請修改我們 <code>Slim-ADR</code> 中的 <code>config/routes.php</code> 和 <code>config/bootstrap.php</code>。</li>
</ul>
<p><code>config/routes.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Slim</span>\<span class="title">Http</span>\<span class="title">Response</span>;</span><br><span class="line"><span class="comment">// 發現使用Slim\Http\Request常常會報錯，所以使用官方的Request當作請求</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">Psr</span>\<span class="title">Http</span>\<span class="title">Message</span>\<span class="title">ServerRequestInterface</span> <span class="title">as</span> <span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Slim</span>\<span class="title">Routing</span>\<span class="title">RouteCollectorProxy</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Slim</span>\<span class="title">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">(App $app)</span> </span>&#123;</span><br><span class="line">  $app-&gt;options(<span class="string">"[&#123;routes.*&#125;]"</span>, <span class="function"><span class="keyword">function</span><span class="params">(Request $req, Response $res, array $args)</span> :<span class="title">Response</span> </span>&#123; <span class="keyword">return</span> $res; &#125;);</span><br><span class="line"></span><br><span class="line">  $app-&gt;group(<span class="string">"/api"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(RouteCollectorProxy $app)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    $app-&gt;get(<span class="string">"/home[/]"</span>, <span class="function"><span class="keyword">function</span><span class="params">(Request $req, Response $res, array $args)</span> :<span class="title">Response</span> </span>&#123; </span><br><span class="line">      <span class="keyword">return</span> $res-&gt;withJson(<span class="string">"GET HOME"</span>, <span class="number">200</span>, JSON_UNESCAPED_UNICODE);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    $app-&gt;get(<span class="string">"/home/&#123;name&#125;[/]"</span>, <span class="function"><span class="keyword">function</span><span class="params">(Request $req, Response $res, array $args)</span> :<span class="title">Response</span> </span>&#123; </span><br><span class="line">      <span class="keyword">return</span> $res-&gt;withJson(<span class="string">"GET Hello &#123;$args['name']&#125;!"</span>, <span class="number">200</span>, JSON_UNESCAPED_UNICODE);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 相對原本基礎篇的寫法，更加精簡且可以清楚知道他是負責處理 Users 的 API </span></span><br><span class="line">    $app-&gt;group(<span class="string">"/user"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(RouteCollectorProxy $app)</span> </span>&#123;</span><br><span class="line">      $app-&gt;get(<span class="string">"[/]"</span>, \App\Action\Users\GetAction::class);</span><br><span class="line">      $app-&gt;post(<span class="string">"[/]"</span>, \App\Action\Users\InsertAction::class);</span><br><span class="line">      $app-&gt;patch(<span class="string">"[/]"</span>, \App\Action\Users\UpdateAction::class);</span><br><span class="line">      $app-&gt;delete(<span class="string">"[/]"</span>, \App\Action\Users\DeleteAction::class);</span><br><span class="line">    &#125;);</span><br><span class="line"> &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>config/bootstrap.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">DI</span>\<span class="title">ContainerBuilder</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Dotenv</span>\<span class="title">Dotenv</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Slim</span>\<span class="title">App</span>;</span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/../vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 註冊我們設定好的CLASS</span></span><br><span class="line">$containerBuilder = <span class="keyword">new</span> ContainerBuilder();</span><br><span class="line">$containerBuilder-&gt;addDefinitions(<span class="keyword">__DIR__</span> . <span class="string">'/container.php'</span>);</span><br><span class="line">$container = $containerBuilder-&gt;build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// LOAD .ENV</span></span><br><span class="line">$dotenv = $container-&gt;get(Dotenv::class);</span><br><span class="line">$dotenv-&gt;load(<span class="keyword">__DIR__</span>.<span class="string">'/../.env'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 建立App INSTANCE</span></span><br><span class="line">$app = $container-&gt;get(App::class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 中間件</span></span><br><span class="line">(<span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/middleware.php'</span>)($app);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 將原本 $db instance 刪除，資料庫操作統一給 Reopsitory 管理</span></span><br><span class="line"><span class="comment">// 路由</span></span><br><span class="line">(<span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/routes.php'</span>)($app);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> $app;</span><br></pre></td></tr></table></figure>


<h2 id="表單驗證和統一回應格式"><a href="#表單驗證和統一回應格式" class="headerlink" title="表單驗證和統一回應格式"></a>表單驗證和統一回應格式</h2><p>當我們設計好一個 ADR 模式的架構之後，肯定會有一些小問題，比如說：要怎麼<code>檢驗 Client 傳遞過來的資料</code>，或是<code>回應</code>的時候要怎麼<code>統一格式</code>，讓前端可以判斷該項<code>請求</code>是否為<code>正確操作</code>。</p>
<h3 id="表單驗證"><a href="#表單驗證" class="headerlink" title="表單驗證"></a>表單驗證</h3><p>那麼<code>表單驗證</code>就誕生了，表單驗證顧名思義就是檢驗傳遞的資料型別是否符合後端需求，如果可以就放行操作，不行則返回哪些傳遞的資料是有問題的。以下是我自己封裝的表單驗證，此依賴存放在 <code>src/Utils</code> 之中。</p>
<p><code>src/Utils/Validation.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Utils</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Validation</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="comment">// 存放錯誤的陣列</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">array</span> $_errors = [];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 驗證</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">validate</span><span class="params">(array $src = [], array $rules = [])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span>($src <span class="keyword">as</span> $item =&gt; $item_value) &#123;</span><br><span class="line">      <span class="keyword">if</span>(key_exists($item, $rules)) &#123;</span><br><span class="line">        <span class="keyword">foreach</span>($rules[$item] <span class="keyword">as</span> $rule =&gt; $rule_value)&#123;</span><br><span class="line">          <span class="keyword">if</span>(is_int($rule)) &#123;</span><br><span class="line">            $rule = $rule_value;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">switch</span> ($rule)&#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 無法為空</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'required'</span>:</span><br><span class="line">              <span class="keyword">if</span>(<span class="keyword">empty</span>($item_value) &amp;&amp; $rule_value)&#123;</span><br><span class="line">                <span class="comment">//empty缺點 0 false會返回true</span></span><br><span class="line">                <span class="keyword">if</span>($item_value === <span class="number">0</span> || $item_value === <span class="keyword">false</span> || $item_value === <span class="string">'0'</span> || $item_value === <span class="number">0.00</span>) &#123;</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;addError($item,ucwords($item). <span class="string">' 無法為空'</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 最小長度</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'minLen'</span>:</span><br><span class="line">              <span class="keyword">if</span>(mb_strlen((string)$item_value) &lt; $rule_value)&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;addError($item, ucwords($item). <span class="string">' 最小長度應為 '</span>.$rule_value. <span class="string">' 個字元'</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 最大長度</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'maxLen'</span>:</span><br><span class="line">              <span class="keyword">if</span>(mb_strlen((string)$item_value) &gt; $rule_value)&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;addError($item, ucwords($item). <span class="string">' 最大長度應為 '</span>.$rule_value. <span class="string">' 個字元'</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 是否為數字</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'numeric'</span>:</span><br><span class="line">              <span class="keyword">if</span>(!is_numeric($item_value) &amp;&amp; $rule_value)&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;addError($item, ucwords($item). <span class="string">' 應為數字'</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 是否為浮點數</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'float'</span>:</span><br><span class="line">              <span class="keyword">if</span>(!is_float($item_value) &amp;&amp; $rule_value)&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;addError($item, ucwords($item). <span class="string">' 應為浮點數'</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 是否為字母</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'alpha'</span>:</span><br><span class="line">              <span class="keyword">if</span>(!ctype_alpha($item_value) &amp;&amp; $rule_value)&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;addError($item, ucwords($item). <span class="string">' 應為字母'</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 是否有空格</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'space'</span>:</span><br><span class="line">              <span class="keyword">if</span>(!ctype_space($item_value) &amp;&amp; $rule_value)&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;addError($item, ucwords($item). <span class="string">' 不應有空格'</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 是否為email格式</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'email'</span>:</span><br><span class="line">              <span class="keyword">if</span>(!filter_var($item_value, FILTER_VALIDATE_EMAIL) &amp;&amp; $rule_value)&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;addError($item, ucwords($item). <span class="string">' 不為Email格式'</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 是否輸入一致</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'same'</span>:</span><br><span class="line">              <span class="keyword">if</span>($item_value != $rule_value &amp;&amp; $rule_value)&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;addError($item, ucwords($item). <span class="string">' 輸入要一致'</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 是否為身分證格式</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'id_number'</span>:</span><br><span class="line">              $map = [</span><br><span class="line">                <span class="string">'A'</span>=&gt;<span class="number">10</span>,<span class="string">'B'</span>=&gt;<span class="number">11</span>,<span class="string">'C'</span>=&gt;<span class="number">12</span>,<span class="string">'D'</span>=&gt;<span class="number">13</span>,<span class="string">'E'</span>=&gt;<span class="number">14</span>,<span class="string">'F'</span>=&gt;<span class="number">15</span>,</span><br><span class="line">                <span class="string">'G'</span>=&gt;<span class="number">16</span>,<span class="string">'H'</span>=&gt;<span class="number">17</span>,<span class="string">'I'</span>=&gt;<span class="number">34</span>,<span class="string">'J'</span>=&gt;<span class="number">18</span>,<span class="string">'K'</span>=&gt;<span class="number">19</span>,<span class="string">'L'</span>=&gt;<span class="number">20</span>,</span><br><span class="line">                <span class="string">'M'</span>=&gt;<span class="number">21</span>,<span class="string">'N'</span>=&gt;<span class="number">22</span>,<span class="string">'O'</span>=&gt;<span class="number">35</span>,<span class="string">'P'</span>=&gt;<span class="number">23</span>,<span class="string">'Q'</span>=&gt;<span class="number">24</span>,<span class="string">'R'</span>=&gt;<span class="number">25</span>,</span><br><span class="line">                <span class="string">'S'</span>=&gt;<span class="number">26</span>,<span class="string">'T'</span>=&gt;<span class="number">27</span>,<span class="string">'U'</span>=&gt;<span class="number">28</span>,<span class="string">'V'</span>=&gt;<span class="number">29</span>,<span class="string">'W'</span>=&gt;<span class="number">32</span>,<span class="string">'X'</span>=&gt;<span class="number">30</span>,</span><br><span class="line">                <span class="string">'Y'</span>=&gt;<span class="number">31</span>,<span class="string">'Z'</span>=&gt;<span class="number">33</span></span><br><span class="line">              ];</span><br><span class="line">              <span class="comment">// ^: 必須以英文開頭</span></span><br><span class="line">              <span class="comment">// $: 必須以數字結尾</span></span><br><span class="line">              <span class="comment">// 先檢查字數可以節省時間</span></span><br><span class="line">              $strLen = strlen($item_value);</span><br><span class="line">              $item_value = strtoupper($item_value);</span><br><span class="line">              <span class="keyword">if</span> (($strLen != <span class="number">10</span> || preg_match(<span class="string">"/^[A-Z][1-2][0-9]+$/"</span>, $item_value) == <span class="number">0</span>) &amp;&amp; $rule_value) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;addError($item, ucwords($item). <span class="string">' 不為身份證格式'</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              $code = <span class="number">0</span>;</span><br><span class="line">              <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; $strLen; $i++)&#123;</span><br><span class="line">                $symbol = substr($item_value,$i,<span class="number">1</span>);</span><br><span class="line">                <span class="comment">// 英文字母</span></span><br><span class="line">                <span class="keyword">if</span>($i == <span class="number">0</span>)&#123;</span><br><span class="line">                  $tmp = $map[$symbol];</span><br><span class="line">                  $code += intval($tmp/<span class="number">10</span>) + ($tmp%<span class="number">10</span>)*<span class="number">9</span>;</span><br><span class="line">                <span class="comment">// 最後一碼</span></span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>($i == $strLen - <span class="number">1</span>)&#123;</span><br><span class="line">                  $code += intval($symbol);</span><br><span class="line">                <span class="comment">// 其他: 乘上 8,7,6,5,4,3,2,1</span></span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                  $code += intval($symbol) * (<span class="number">9</span> - $i);</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span>($code % <span class="number">10</span> != <span class="number">0</span> &amp;&amp; $rule_value)&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;addError($item, ucwords($item). <span class="string">' 不為身份證格式'</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;    </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果不符合，就新增錯誤</span></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">addError</span><span class="params">($item, $error)</span></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;_errors[$item][] = $error;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判斷$this-&gt;_errors中有沒有值，沒有代表驗證成功</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">error</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;_errors)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_errors;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="統一回應格式"><a href="#統一回應格式" class="headerlink" title="統一回應格式"></a>統一回應格式</h3><p>我們通常設計 RESTful API 會給前端<code>狀態碼</code>、<code>資料</code>、<code>訊息</code>當作他們請求是否成功的依據，並且可以透過<code>狀態碼</code>去得知這是甚麼問題。通常我習慣將狀態碼寫在回應格式之中，而非改變http status code(單純只是習慣而已)，如果有疑慮也會偏向與大家整合他們開發的習慣。以下是我封裝的 <code>ResponseFormat.php</code> 也是放在 <code>src/Utils</code> 目錄下。</p>
<p><code>src/Utils/ResponseFormat.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Utils</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResponseFormat</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> int $code;</span><br><span class="line">  <span class="keyword">public</span> mixed $data;</span><br><span class="line">  <span class="keyword">public</span> mixed $message;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">format</span><span class="params">(int $status = <span class="number">200</span>, mixed $data = null, mixed $message = null)</span>: <span class="title">ResponseFormat</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="comment">// RESET</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;reset();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(gettype($data) === <span class="string">'string'</span>) &#123;</span><br><span class="line">      <span class="keyword">$this</span>-&gt;message = $data;</span><br><span class="line">      $data = <span class="keyword">null</span>;</span><br><span class="line">      $message = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>($data) &#123;</span><br><span class="line">      <span class="keyword">$this</span>-&gt;data = $data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>($message) &#123;</span><br><span class="line">      <span class="keyword">$this</span>-&gt;message = $message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;code = $status;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">reset</span><span class="params">()</span>: <span class="title">void</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;code = <span class="number">200</span>;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;data = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;message = <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h3><p>一開始我們通常會先在建構子上先傳遞這兩個依賴讓 <code>php-di</code> 幫助我們使用自動配裝。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@var</span> UsersRepository */</span></span><br><span class="line"><span class="keyword">private</span> UsersRepository $repository;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@var</span> ResponseFormat */</span></span><br><span class="line"><span class="keyword">private</span> ResponseFormat $res;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@var</span> Validation */</span></span><br><span class="line"><span class="keyword">private</span> Validation $v;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(UsersRepository $repository, ResponseFormat $res, Validation $v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">$this</span>-&gt;repository = $repository;</span><br><span class="line">  <span class="keyword">$this</span>-&gt;res = $res;</span><br><span class="line">  <span class="keyword">$this</span>-&gt;v = $v;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然後在 <code>Service</code> 的處理中，使用 <code>$this-&gt;v-&gt;validate()</code> 開啟驗證，並且查看 <code>$this-&gt;v-&gt;error()</code> 是否為 true，是的話就返回錯誤的資訊。<br><code>$this-&gt;res-&gt;format()</code>就是我們封裝好的格式，第一個參數是<code>狀態碼</code>、第二個是<code>資料</code>、第三個是<code>訊息</code>。當我們第二個參數是<code>字串</code>的時候，格式會自動改成<code>訊息</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">deleteUser</span><span class="params">(array $data)</span>: <span class="title">ResponseFormat</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// Validation</span></span><br><span class="line">  <span class="keyword">$this</span>-&gt;v-&gt;validate(</span><br><span class="line">    [<span class="string">"ID"</span> =&gt; (!<span class="keyword">empty</span>($data[<span class="string">"id"</span>]) ? $data[<span class="string">"id"</span>] : <span class="string">""</span>)],</span><br><span class="line">    [<span class="string">"ID"</span> =&gt; [<span class="string">"required"</span>, <span class="string">"maxLen"</span> =&gt; <span class="number">11</span>]]</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Invalid</span></span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;v-&gt;error()) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;res-&gt;format(<span class="number">401</span>, <span class="keyword">$this</span>-&gt;v-&gt;error(),<span class="string">"提交格式有誤!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">$this</span>-&gt;repository-&gt;deleteUser([<span class="string">"id"</span> =&gt; $data[<span class="string">"id"</span>]]);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;res-&gt;format(<span class="number">200</span>, <span class="string">"Success"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>介紹完之後，我們可以將之前的四個 <code>Service</code> 套用上我們寫的依賴之中。</li>
</ul>
<p><code>src/Domain/Users/Service/GetService.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Domain</span>\<span class="title">Users</span>\<span class="title">Service</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Domain</span>\<span class="title">Users</span>\<span class="title">Repository</span>\<span class="title">UsersRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Utils</span>\<span class="title">ResponseFormat</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GetService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** <span class="doctag">@var</span> UsersRepository */</span></span><br><span class="line">  <span class="keyword">private</span> UsersRepository $repository;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** <span class="doctag">@var</span> ResponseFormat */</span></span><br><span class="line">  <span class="keyword">private</span> ResponseFormat $res;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> UsersRepository $repository DB操作</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(UsersRepository $repository, ResponseFormat $res)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;repository = $repository;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;res = $res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 獲取Users</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> array $user 資料型別</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> ResponseFormat </span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getUsers</span><span class="params">()</span>: <span class="title">ResponseFormat</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="comment">// 獲取Users</span></span><br><span class="line">    $data = <span class="keyword">$this</span>-&gt;repository-&gt;getUsers();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;res-&gt;format(<span class="number">200</span>, $data);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>src/Domain/Users/Service/InsertService.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Domain</span>\<span class="title">Users</span>\<span class="title">Service</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Domain</span>\<span class="title">Users</span>\<span class="title">Repository</span>\<span class="title">UsersRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Utils</span>\<span class="title">ResponseFormat</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Utils</span>\<span class="title">Validation</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">InsertService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** <span class="doctag">@var</span> UsersRepository */</span></span><br><span class="line">  <span class="keyword">private</span> UsersRepository $repository;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** <span class="doctag">@var</span> ResponseFormat */</span></span><br><span class="line">  <span class="keyword">private</span> ResponseFormat $res;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** <span class="doctag">@var</span> Validation */</span></span><br><span class="line">  <span class="keyword">private</span> Validation $v;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> UsersRepository $repository DB操作</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> ResponseFormat $res 回傳固定格式</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> Validation $v 表單驗證</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(UsersRepository $repository, ResponseFormat $res, Validation $v)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;repository = $repository;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;res = $res;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;v = $v;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 插入User</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> array $user 資料型別</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> array Users array</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">insertUser</span><span class="params">(array $data)</span>: <span class="title">ResponseFormat</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="comment">// Validation</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;v-&gt;validate(</span><br><span class="line">      [</span><br><span class="line">        <span class="string">"姓名"</span> =&gt; (!<span class="keyword">empty</span>($data[<span class="string">"name"</span>]) ? $data[<span class="string">"name"</span>] : <span class="string">""</span>),</span><br><span class="line">        <span class="string">"密碼"</span> =&gt; (!<span class="keyword">empty</span>($data[<span class="string">"password"</span>]) ? $data[<span class="string">"password"</span>] : <span class="string">""</span>),</span><br><span class="line">      ],</span><br><span class="line">      [</span><br><span class="line">        <span class="string">"姓名"</span> =&gt; [<span class="string">"required"</span>, <span class="string">"maxLen"</span> =&gt; <span class="number">64</span>],</span><br><span class="line">        <span class="string">"密碼"</span> =&gt; [<span class="string">"required"</span>, <span class="string">"maxLen"</span> =&gt; <span class="number">64</span>],</span><br><span class="line">      ]</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Invalid</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;v-&gt;error()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;res-&gt;format(<span class="number">401</span>, <span class="keyword">$this</span>-&gt;v-&gt;error(),<span class="string">"提交格式有誤!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $data[<span class="string">"password"</span>] = md5($data[<span class="string">"password"</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;repository-&gt;insertUser($data);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;res-&gt;format(<span class="number">200</span>, <span class="string">"Success"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>src/Domain/Users/Service/UpdateService.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Domain</span>\<span class="title">Users</span>\<span class="title">Service</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Domain</span>\<span class="title">Users</span>\<span class="title">Repository</span>\<span class="title">UsersRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Utils</span>\<span class="title">ResponseFormat</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Utils</span>\<span class="title">Validation</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">UpdateService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** <span class="doctag">@var</span> UsersRepository */</span></span><br><span class="line">  <span class="keyword">private</span> UsersRepository $repository;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** <span class="doctag">@var</span> ResponseFormat */</span></span><br><span class="line">  <span class="keyword">private</span> ResponseFormat $res;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** <span class="doctag">@var</span> Validation */</span></span><br><span class="line">  <span class="keyword">private</span> Validation $v;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> UsersRepository $repository DB操作</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> ResponseFormat $res 回傳固定格式</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> Validation $v 表單驗證</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(UsersRepository $repository, ResponseFormat $res, Validation $v)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;repository = $repository;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;res = $res;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;v = $v;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 更新Users</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> array $user 資料型別</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> array Users array</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">updateUser</span><span class="params">(array $data)</span>: <span class="title">ResponseFormat</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="comment">// Validation</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;v-&gt;validate(</span><br><span class="line">      [</span><br><span class="line">        <span class="string">"ID"</span> =&gt; (!<span class="keyword">empty</span>($data[<span class="string">"id"</span>]) ? $data[<span class="string">"id"</span>] : <span class="string">""</span>),</span><br><span class="line">        <span class="string">"姓名"</span> =&gt; (!<span class="keyword">empty</span>($data[<span class="string">"name"</span>]) ? $data[<span class="string">"name"</span>] : <span class="string">""</span>)</span><br><span class="line">      ],</span><br><span class="line">      [</span><br><span class="line">        <span class="string">"ID"</span> =&gt; [<span class="string">"required"</span>, <span class="string">"maxLen"</span> =&gt; <span class="number">11</span>],</span><br><span class="line">        <span class="string">"姓名"</span> =&gt; [<span class="string">"required"</span>, <span class="string">"maxLen"</span> =&gt; <span class="number">64</span>]</span><br><span class="line">      ]</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Invalid</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;v-&gt;error()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;res-&gt;format(<span class="number">401</span>, <span class="keyword">$this</span>-&gt;v-&gt;error(),<span class="string">"提交格式有誤!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;repository-&gt;updateUser(</span><br><span class="line">      [<span class="string">"name"</span> =&gt; $data[<span class="string">"name"</span>]],</span><br><span class="line">      [<span class="string">"id"</span> =&gt; $data[<span class="string">"id"</span>]]</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;res-&gt;format(<span class="number">200</span>, <span class="string">"Success"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><code>src/Domain/Users/Service/DeleteService.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Domain</span>\<span class="title">Users</span>\<span class="title">Service</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Domain</span>\<span class="title">Users</span>\<span class="title">Repository</span>\<span class="title">UsersRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Utils</span>\<span class="title">ResponseFormat</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Utils</span>\<span class="title">Validation</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DeleteService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** <span class="doctag">@var</span> UsersRepository */</span></span><br><span class="line">  <span class="keyword">private</span> UsersRepository $repository;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** <span class="doctag">@var</span> ResponseFormat */</span></span><br><span class="line">  <span class="keyword">private</span> ResponseFormat $res;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** <span class="doctag">@var</span> Validation */</span></span><br><span class="line">  <span class="keyword">private</span> Validation $v;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> UsersRepository $repository DB操作</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> ResponseFormat $res 回傳固定格式</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> Validation $v 表單驗證</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(UsersRepository $repository, ResponseFormat $res, Validation $v)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;repository = $repository;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;res = $res;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;v = $v;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 刪除Users</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> array $user 資料型別</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> array Users array</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">deleteUser</span><span class="params">(array $data)</span>: <span class="title">ResponseFormat</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="comment">// Validation</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;v-&gt;validate(</span><br><span class="line">      [<span class="string">"ID"</span> =&gt; (!<span class="keyword">empty</span>($data[<span class="string">"id"</span>]) ? $data[<span class="string">"id"</span>] : <span class="string">""</span>)],</span><br><span class="line">      [<span class="string">"ID"</span> =&gt; [<span class="string">"required"</span>, <span class="string">"maxLen"</span> =&gt; <span class="number">11</span>]]</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Invalid</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;v-&gt;error()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;res-&gt;format(<span class="number">401</span>, <span class="keyword">$this</span>-&gt;v-&gt;error(),<span class="string">"提交格式有誤!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;repository-&gt;deleteUser([<span class="string">"id"</span> =&gt; $data[<span class="string">"id"</span>]]);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;res-&gt;format(<span class="number">200</span>, <span class="string">"Success"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="成果展示"><a href="#成果展示" class="headerlink" title="成果展示"></a>成果展示</h3><ul>
<li>使用 docker 開啟服務</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<ul>
<li>用 postman 依序操作 插入(沒資料) -&gt; 插入(有資料) -&gt; 獲取<br><img src="/images/Build-a-PHP-RESTful-Framework-using-Slim-4-Part2/1.jpg" alt=""><br><img src="/images/Build-a-PHP-RESTful-Framework-using-Slim-4-Part2/2.jpg" alt=""><br><img src="/images/Build-a-PHP-RESTful-Framework-using-Slim-4-Part2/3.jpg" alt=""></li>
</ul>
<h2 id="登入和Jwt"><a href="#登入和Jwt" class="headerlink" title="登入和Jwt"></a>登入和Jwt</h2><p>一般我們在使用 Http 這種 Stateless 的協議的時候，通常無法辨識我們的使用者的真實身分，除非藉由以下兩種方式。</p>
<ol>
<li><code>使用 Cookie Session</code>，通常我們在登入的時候 Sever 會將使用者資料存放在 Session 的記憶體之中，並且分發 Cookie(夾帶SessionId) 給 Client，讓 Client 每次請求的時候將 Cookie 當作身分證連同傳送到 Server。</li>
<li><code>使用 Jwt</code>，我們在登入的時候 Server 會將使用者資料加密，並且存成特定格式返回給 Client(Server 不做儲存)，並且每次我們在請求的時候都會從 Header 的 Authorization 欄位去查找有沒有這種 Token 的加密身分證。</li>
</ol>
<blockquote>
<p>由於 SPA、手機 APP 這種前後端分離的方式逐漸流行，Cookie Session 漸漸也開始被棄用了，其中不方便是一個原因，再來如果是分散式系統的話要儲存在記憶體只能依賴 <code>Redis</code> 這種<code>記憶體型的資料庫</code>才能夠達成。</p>
</blockquote>
<p><img src="/images/Build-a-PHP-RESTful-Framework-using-Slim-4-Part2/jwt.png" alt=""></p>
<h3 id="Jwt"><a href="#Jwt" class="headerlink" title="Jwt"></a>Jwt</h3><h4 id="介紹"><a href="#介紹" class="headerlink" title="介紹"></a>介紹</h4><p>Jwt的組成分成三部分。</p>
<ol>
<li><code>Header</code>：通常存放<code>加密的類型</code>和<code>該Token的類型</code>。<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"alg"</span>: <span class="string">"SHA256"</span>,</span><br><span class="line">  <span class="attr">"typ"</span>: <span class="string">"JWT"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><code>Payload</code>：一般裡面會有我們<code>使用者的訊息</code>、<code>簽發者</code>、<code>使用期限</code>…等資訊。<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">// Registered claims，一般JWT會用到的資訊</span></span><br><span class="line">  <span class="attr">"iss"</span>: <span class="string">"http://example.com"</span>, <span class="comment">// Issuer 簽發者，可以使用域名來當作驗證該TOKEN是誰製造的</span></span><br><span class="line">  <span class="attr">"iat"</span>: <span class="string">"120000000"</span>, <span class="comment">// Issued At JWT簽發時間</span></span><br><span class="line">  <span class="attr">"exp"</span>: <span class="string">"155555555"</span>, <span class="comment">// Expiration Time JWT的過期時間，過期時間必須大於簽發JWT時間</span></span><br><span class="line">  <span class="attr">"sub"</span>: <span class="string">"1234567890"</span>, <span class="comment">// Subject JWT的主題是甚麼</span></span><br><span class="line">  <span class="attr">"aud"</span>: <span class="string">"all"</span>, <span class="comment">// Audience 接收JWT的一方，預期這個TOKEN是給誰用的</span></span><br><span class="line">  <span class="attr">"nbf"</span>: <span class="string">"130000000"</span>, <span class="comment">// Not Before 定義發放JWT之後多久才生效</span></span><br><span class="line">  <span class="attr">"jti"</span> : <span class="string">"asd123"</span> <span class="comment">// JWT 的 Id JWT的身分標示，每個JWT的Id都應該是不重複的，避免重複發放</span></span><br><span class="line">  <span class="comment">// Private claims，Server 可以依照自己的方式設置擺放什麼info，盡量避免密碼相關的敏感訊息</span></span><br><span class="line">  <span class="string">"user_info"</span>: &#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"Bob"</span>,</span><br><span class="line">    <span class="attr">"user_id"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"roles"</span>: <span class="string">"admin"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// Public claims，一般來說不太會用到</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><code>Signature</code>：<code>base64UrlEncode(header)</code>、<code>base64UrlEncode(payload)</code>、<code>secret</code>三個部分加密而成。</li>
</ol>
<h4 id="安裝-1"><a href="#安裝-1" class="headerlink" title="安裝"></a>安裝</h4><p>安裝 <code>lcobucci/jwt: ^4.0</code> 的一個 Jwt 的依賴庫，本次實作使用 <code>4.0</code> 版本，因為不同版本所用的函數不同，所以安裝前請先確認版本是否正確。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer require <span class="string">"lcobucci/jwt"</span>: <span class="string">"^4.0"</span></span><br></pre></td></tr></table></figure>

<h4 id="產生公鑰和私鑰"><a href="#產生公鑰和私鑰" class="headerlink" title="產生公鑰和私鑰"></a>產生公鑰和私鑰</h4><p>我們使用 RSA 的加密方式來進行簽名。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 產生私鑰</span></span><br><span class="line">openssl genrsa -out private.pem 2048</span><br><span class="line"><span class="comment"># 產生公鑰</span></span><br><span class="line">openssl rsa -<span class="keyword">in</span> private.pem -outform PEM -pubout -out public.pem</span><br></pre></td></tr></table></figure>

<h4 id="env配置"><a href="#env配置" class="headerlink" title=".env配置"></a>.env配置</h4><p>原本的 <code>.env.example</code> 已經有配置好了，不過生產環境還是建議獨立生成一個公鑰私鑰以防萬一。</p>
<p><code>.env</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># JWT SETTINGS</span><br><span class="line">JWT_ISSUER&#x3D;SLIM_4</span><br><span class="line">JWT_LIFETIME&#x3D;86400</span><br><span class="line">JWT_PRIVATE_KEY&#x3D;&quot;-----BEGIN RSA PRIVATE KEY-----</span><br><span class="line">MIIBPQIBAAJBALSlDUfngNVzILQh0UDzg22Wd3NCvHrl1PMK+IxRoTQovLN3TQ8E</span><br><span class="line">oBgL7GqHTYSrnnADrV0JSgf8onbDzkvZoYcCAwEAAQJBALEY5w5JPZsFRViTlsww</span><br><span class="line">b&#x2F;bt&#x2F;qk3EgUCcWTcqpMWLA4vBBH7&#x2F;guLZvyWG1U4Q63vgO1SSA7g+bwMvmDMCj6l</span><br><span class="line">fhECIQDc6&#x2F;A9mYXirCwHL0iKb5o1R&#x2F;ri4NqZYrcoGUrYhpntZQIhANFT7k4SffT0</span><br><span class="line">3PSK1Pa2OcsnfuBMmqZcld3DP8+lCip7AiEAhRaZ9vIaxxBDwdxJTiSneLuxN6aP</span><br><span class="line">6mGex0hdX43PA0UCIQDNZjD41LZZjYfeQPg1WZueF5QsnZ5GTaUUpIjRxF0UTwIh</span><br><span class="line">AMa&#x2F;1Gkl&#x2F;FUaiZaFm6KMysKHAeWg3YZudouHoDLDcDbl</span><br><span class="line">-----END RSA PRIVATE KEY-----&quot;</span><br><span class="line">JWT_PUBLIC_KEY&#x3D;&quot;-----BEGIN PUBLIC KEY-----</span><br><span class="line">MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBALSlDUfngNVzILQh0UDzg22Wd3NCvHrl</span><br><span class="line">1PMK+IxRoTQovLN3TQ8EoBgL7GqHTYSrnnADrV0JSgf8onbDzkvZoYcCAwEAAQ&#x3D;&#x3D;</span><br><span class="line">-----END PUBLIC KEY-----&quot;</span><br></pre></td></tr></table></figure>

<h4 id="建立-Jwt-的函式庫"><a href="#建立-Jwt-的函式庫" class="headerlink" title="建立 Jwt 的函式庫"></a>建立 Jwt 的函式庫</h4><p>基本上就是實現我們的<code>建立 Jwt</code>、<code>驗證 Jwt</code>、<code>解析 Jwt</code>的方法。</p>
<p><code>src/Utils/Jwt.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Utils</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">use</span> <span class="title">UnexpectedValueException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">InvalidArgumentException</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Lcobucci</span>\<span class="title">JWT</span>\<span class="title">Configuration</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Lcobucci</span>\<span class="title">JWT</span>\<span class="title">Signer</span>\<span class="title">Hmac</span>\<span class="title">Sha256</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Lcobucci</span>\<span class="title">JWT</span>\<span class="title">Signer</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Lcobucci</span>\<span class="title">JWT</span>\<span class="title">Signer</span>\<span class="title">Key</span>\<span class="title">InMemory</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Lcobucci</span>\<span class="title">JWT</span>\<span class="title">Token</span>\<span class="title">Plain</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Lcobucci</span>\<span class="title">JWT</span>\<span class="title">Validation</span>\<span class="title">Constraint</span>\<span class="title">SignedWith</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Lcobucci</span>\<span class="title">JWT</span>\<span class="title">Validation</span>\<span class="title">Constraint</span>\<span class="title">IssuedBy</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Lcobucci</span>\<span class="title">JWT</span>\<span class="title">Validation</span>\<span class="title">Constraint</span>\<span class="title">IdentifiedBy</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Lcobucci</span>\<span class="title">JWT</span>\<span class="title">Validation</span>\<span class="title">Constraint</span>\<span class="title">ValidAt</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Lcobucci</span>\<span class="title">Clock</span>\<span class="title">SystemClock</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">DateTimeImmutable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">DateTimeZone</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Jwt</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> string The issuer name */</span></span><br><span class="line">    <span class="keyword">private</span> string $issuer;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> int Max lifetime in seconds */</span></span><br><span class="line">    <span class="keyword">private</span> int $lifetime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Configuration config */</span></span><br><span class="line">    <span class="keyword">private</span> Configuration $config;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The constructor.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $issuer The issuer name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int $lifetime The max lifetime</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $privateKey The private key as string</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $publicKey The public key as string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        string $issuer,</span></span></span><br><span class="line"><span class="function"><span class="params">        int $lifetime,</span></span></span><br><span class="line"><span class="function"><span class="params">        string $privateKey,</span></span></span><br><span class="line"><span class="function"><span class="params">        string $publicKey</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;issuer = $issuer;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;lifetime = $lifetime;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;signer = <span class="keyword">new</span> Signer\Rsa\Sha256();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;publicKey = $publicKey;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;config = Configuration::forAsymmetricSigner(</span><br><span class="line">          <span class="comment">// You may use RSA or ECDSA and all their variations (256, 384, and 512) and EdDSA over Curve25519</span></span><br><span class="line">          <span class="keyword">$this</span>-&gt;signer,</span><br><span class="line">          InMemory::plainText($privateKey), </span><br><span class="line">          InMemory::plainText($publicKey)</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get JWT max lifetime.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int The lifetime in seconds</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getLifetime</span><span class="params">()</span>: <span class="title">int</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;lifetime;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create JSON web token.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $uid The user id</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> UnexpectedValueException</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string The JWT</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createJwt</span><span class="params">(array $info)</span>: <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      $issuedAt = <span class="keyword">new</span> DateTimeImmutable();</span><br><span class="line">      <span class="comment">// print_r($this-&gt;v5_UUID("", 'JWT_TOKEN'));exit;</span></span><br><span class="line">      <span class="keyword">return</span> (<span class="keyword">$this</span>-&gt;config-&gt;builder()</span><br><span class="line">          -&gt;issuedBy(<span class="keyword">$this</span>-&gt;issuer)</span><br><span class="line">          -&gt;permittedFor(<span class="keyword">$this</span>-&gt;issuer)</span><br><span class="line">          -&gt;identifiedBy(<span class="keyword">$this</span>-&gt;v5_UUID(<span class="string">"0x752222"</span>, <span class="string">"JWT_TOKEN"</span>), <span class="keyword">true</span>)</span><br><span class="line">          <span class="comment">// Configures the time that the token was issue (iat claim)</span></span><br><span class="line">          -&gt;issuedAt($issuedAt)</span><br><span class="line">          <span class="comment">// Configures the time that the token can be used (nbf claim)</span></span><br><span class="line">          -&gt;canOnlyBeUsedAfter($issuedAt)</span><br><span class="line">          <span class="comment">// Configures the expiration time of the token (exp claim)</span></span><br><span class="line">          -&gt;expiresAt($issuedAt-&gt;modify(<span class="string">"+&#123;$this-&gt;lifetime&#125; seconds"</span>))</span><br><span class="line">          <span class="comment">// Configures a new claim, called "uid"</span></span><br><span class="line">          -&gt;withClaim(<span class="string">"info"</span>, $info)</span><br><span class="line">          <span class="comment">// // Configures a new header, called "foo"</span></span><br><span class="line">          <span class="comment">// -&gt;withHeader("foo", "bar")</span></span><br><span class="line">          <span class="comment">// Builds a new token</span></span><br><span class="line">          -&gt;getToken(<span class="keyword">$this</span>-&gt;config-&gt;signer(), <span class="keyword">$this</span>-&gt;config-&gt;signingKey())</span><br><span class="line">        )-&gt;toString();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Parse token.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $token The JWT</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> InvalidArgumentException</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Token The parsed token</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createParsedToken</span><span class="params">(string $token)</span>: <span class="title">Plain</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;config-&gt;parser()-&gt;parse($token);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Validate the access token.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $accessToken The JWT</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool The status</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">validateToken</span><span class="params">(string $accessToken)</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      $token = <span class="keyword">$this</span>-&gt;createParsedToken($accessToken);</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">$this</span>-&gt;config-&gt;setValidationConstraints(<span class="keyword">new</span> SignedWith(<span class="keyword">$this</span>-&gt;config-&gt;signer(), <span class="keyword">$this</span>-&gt;config-&gt;verificationKey()));</span><br><span class="line">      <span class="keyword">$this</span>-&gt;config-&gt;setValidationConstraints(<span class="keyword">new</span> IssuedBy($token-&gt;claims()-&gt;get(<span class="string">"iss"</span>)));</span><br><span class="line">      <span class="keyword">$this</span>-&gt;config-&gt;setValidationConstraints(<span class="keyword">new</span> IdentifiedBy($token-&gt;claims()-&gt;get(<span class="string">"jti"</span>)));</span><br><span class="line">      <span class="keyword">$this</span>-&gt;config-&gt;setValidationConstraints(<span class="keyword">new</span> ValidAt(<span class="keyword">new</span> SystemClock(<span class="keyword">new</span> DateTimeZone(<span class="string">"Asia/Taipei"</span>))));</span><br><span class="line"></span><br><span class="line">      $constraints = <span class="keyword">$this</span>-&gt;config-&gt;validationConstraints();</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;config-&gt;validator()-&gt;validate($token, ...$constraints)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">v5_UUID</span><span class="params">(string $name_space, string $string)</span>: <span class="title">string</span> </span>&#123;</span><br><span class="line">      $n_hex = preg_replace(<span class="string">'/[^0-9A-Fa-f\-\(\)]/'</span>, <span class="string">''</span>, $name_space); <span class="comment">// Getting hexadecimal components of namespace</span></span><br><span class="line">      $binray_str = <span class="string">''</span>; <span class="comment">// Binary value string</span></span><br><span class="line">      <span class="comment">//Namespace UUID to bits conversion</span></span><br><span class="line">      <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; strlen($n_hex); $i+=<span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>($n_hex[$i+<span class="number">1</span>])) &#123;</span><br><span class="line">          $binray_str .= chr(hexdec($n_hex[$i]));</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $binray_str .= chr(hexdec($n_hex[$i].$n_hex[$i+<span class="number">1</span>]));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//hash value</span></span><br><span class="line">      $hashing = sha1($binray_str . $string);</span><br><span class="line">  </span><br><span class="line">      <span class="keyword">return</span> sprintf(<span class="string">'%08s-%04s-%04x-%04x-%12s'</span>,</span><br><span class="line">        <span class="comment">// 32 bits for the time_low</span></span><br><span class="line">        substr($hashing, <span class="number">0</span>, <span class="number">8</span>),</span><br><span class="line">        <span class="comment">// 16 bits for the time_mid</span></span><br><span class="line">        substr($hashing, <span class="number">8</span>, <span class="number">4</span>),</span><br><span class="line">        <span class="comment">// 16 bits for the time_hi,</span></span><br><span class="line">        (hexdec(substr($hashing, <span class="number">12</span>, <span class="number">4</span>)) &amp; <span class="number">0x0fff</span>) | <span class="number">0x5000</span>,</span><br><span class="line">        <span class="comment">// 8 bits and 16 bits for the clk_seq_hi_res,</span></span><br><span class="line">        <span class="comment">// 8 bits for the clk_seq_low,</span></span><br><span class="line">        (hexdec(substr($hashing, <span class="number">16</span>, <span class="number">4</span>)) &amp; <span class="number">0x3fff</span>) | <span class="number">0x8000</span>,</span><br><span class="line">        <span class="comment">// 48 bits for the node</span></span><br><span class="line">        substr($hashing, <span class="number">20</span>, <span class="number">12</span>)</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="容器-Jwt-配置"><a href="#容器-Jwt-配置" class="headerlink" title="容器 Jwt 配置"></a>容器 Jwt 配置</h4><p><code>config/container.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Utils</span>\<span class="title">Jwt</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Slim</span>\<span class="title">Http</span>\<span class="title">Factory</span>\<span class="title">DecoratedResponseFactory</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> [</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// JWT</span></span><br><span class="line">  Jwt::class =&gt; <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Jwt($_ENV[<span class="string">"JWT_ISSUER"</span>], (int)$_ENV[<span class="string">"JWT_LIFETIME"</span>], $_ENV[<span class="string">"JWT_PRIVATE_KEY"</span>], $_ENV[<span class="string">"JWT_PUBLIC_KEY"</span>]);</span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Middleware擴充用</span></span><br><span class="line">  DecoratedResponseFactory::class =&gt; <span class="function"><span class="keyword">function</span> <span class="params">(ContainerInterface $container)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> $container-&gt;get(App::class)-&gt;getResponseFactory();</span><br><span class="line">  &#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<h3 id="登入和登出"><a href="#登入和登出" class="headerlink" title="登入和登出"></a>登入和登出</h3><p>當我們完成了 Jwt 的函式庫之後，我們就可以來實現登入登出的功能。</p>
<h4 id="Action-1"><a href="#Action-1" class="headerlink" title="Action"></a>Action</h4><p>請建立 <code>src/Action/Auth</code> 目錄，並且新增 <code>src/Action/Auth/LoginAction.php</code> 和 <code>src/Action/Auth/LogoutAction.php</code>。</p>
<p><code>src/Action/Auth/LoginAction.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Action</span>\<span class="title">Auth</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Slim</span>\<span class="title">Http</span>\<span class="title">Response</span>;</span><br><span class="line"><span class="comment">// 發現使用Slim\Http\Request常常會報錯，所以使用官方的Request當作請求</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">Psr</span>\<span class="title">Http</span>\<span class="title">Message</span>\<span class="title">ServerRequestInterface</span> <span class="title">as</span> <span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Domain</span>\<span class="title">Auth</span>\<span class="title">Service</span>\<span class="title">LoginService</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginAction</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> LoginService The login service </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> LoginService $service;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(LoginService $service)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;service = $service;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">(Request $req, Response $res)</span>: <span class="title">Response</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $data = (<span class="keyword">array</span>)$req-&gt;getParsedBody();</span><br><span class="line">        $return = <span class="keyword">$this</span>-&gt;service-&gt;login($data);</span><br><span class="line">        <span class="keyword">return</span> $res-&gt;withJson($return, <span class="number">200</span>, JSON_UNESCAPED_UNICODE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>src/Action/Auth/LogoutAction.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Action</span>\<span class="title">Auth</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Slim</span>\<span class="title">Http</span>\<span class="title">Response</span>;</span><br><span class="line"><span class="comment">// 發現使用Slim\Http\Request常常會報錯，所以使用官方的Request當作請求</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">Psr</span>\<span class="title">Http</span>\<span class="title">Message</span>\<span class="title">ServerRequestInterface</span> <span class="title">as</span> <span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Domain</span>\<span class="title">Auth</span>\<span class="title">Service</span>\<span class="title">LogoutService</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LogoutAction</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> LogoutService The Logout service */</span></span><br><span class="line">    <span class="keyword">private</span> LogoutService $service;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(LogoutService $service)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      <span class="keyword">$this</span>-&gt;service = $service;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">(Request $req, Response $res)</span>: <span class="title">Response</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      $return = <span class="keyword">$this</span>-&gt;service-&gt;logout();</span><br><span class="line">      <span class="keyword">return</span> $res-&gt;withJson($return, <span class="number">200</span>, JSON_UNESCAPED_UNICODE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Service-1"><a href="#Service-1" class="headerlink" title="Service"></a>Service</h4><p>然後在 <code>src/Domain/Auth</code> 的目錄下新增相對應的 Service <code>src/Domain/Auth/Service/LoginService.php</code> 和 <code>src/Domain/Auth/Service/LogoutService.php</code>。<br><code>src/Domain/Auth/Service/LoginService.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Domain</span>\<span class="title">Auth</span>\<span class="title">Service</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Domain</span>\<span class="title">Auth</span>\<span class="title">Repository</span>\<span class="title">AuthRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Utils</span>\<span class="title">ResponseFormat</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Utils</span>\<span class="title">Validation</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Utils</span>\<span class="title">Jwt</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** <span class="doctag">@var</span> AuthRepository */</span></span><br><span class="line">  <span class="keyword">private</span> AuthRepository $repository;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** <span class="doctag">@var</span> ResponseFormat */</span></span><br><span class="line">  <span class="keyword">private</span> ResponseFormat $res;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** <span class="doctag">@var</span> Validation */</span></span><br><span class="line">  <span class="keyword">private</span> Validation $v;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** <span class="doctag">@var</span> Jwt */</span></span><br><span class="line">  <span class="keyword">private</span> Jwt $jwt;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> AuthRepository $repository DB操作</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> ResponseFormat response</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> Validation 表單驗證</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(AuthRepository $repository, ResponseFormat $res, Validation $v, Jwt $jwt)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;repository = $repository;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;res = $res;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;v = $v;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;jwt = $jwt;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Login</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> array $name, $password</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> ResponseFormat </span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">(array $data)</span>: <span class="title">ResponseFormat</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;v-&gt;validate(</span><br><span class="line">      [</span><br><span class="line">        <span class="string">"帳號"</span> =&gt; (!<span class="keyword">empty</span>($data[<span class="string">"name"</span>]) ? $data[<span class="string">"name"</span>] : <span class="string">""</span>),</span><br><span class="line">        <span class="string">"密碼"</span> =&gt; (!<span class="keyword">empty</span>($data[<span class="string">"password"</span>]) ? $data[<span class="string">"password"</span>] : <span class="string">""</span>)</span><br><span class="line">      ],</span><br><span class="line">      [</span><br><span class="line">        <span class="string">"帳號"</span> =&gt; [<span class="string">"required"</span>, <span class="string">"maxLen"</span> =&gt; <span class="number">64</span>],</span><br><span class="line">        <span class="string">"密碼"</span> =&gt; [<span class="string">"required"</span>, <span class="string">"maxLen"</span> =&gt; <span class="number">64</span>]</span><br><span class="line">      ]</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Invalid</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;v-&gt;error()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;res-&gt;format(<span class="number">401</span>, <span class="keyword">$this</span>-&gt;v-&gt;error(),<span class="string">"提交格式有誤!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $data[<span class="string">"password"</span>] = md5($data[<span class="string">"password"</span>]);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 查看登入</span></span><br><span class="line">    $data = <span class="keyword">$this</span>-&gt;repository-&gt;login(<span class="string">"*"</span>, $data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!$data) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;res-&gt;format(<span class="number">400</span>, <span class="string">"帳號或密碼錯誤"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Transform the result into a OAuh 2.0 Access Token Response</span></span><br><span class="line">    <span class="comment">// https://www.oauth.com/oauth2-servers/access-tokens/access-token-response/</span></span><br><span class="line">    $token = <span class="keyword">$this</span>-&gt;jwt-&gt;createJwt([<span class="string">"name"</span> =&gt; $data[<span class="number">0</span>][<span class="string">"name"</span>], <span class="string">"role"</span> =&gt; <span class="string">"admin"</span>]);</span><br><span class="line">    $lifetime = <span class="keyword">$this</span>-&gt;jwt-&gt;getLifetime();</span><br><span class="line">    $result = [</span><br><span class="line">        <span class="string">"access_token"</span> =&gt; $token,</span><br><span class="line">        <span class="string">"token_type"</span> =&gt; <span class="string">"Bearer"</span>,</span><br><span class="line">        <span class="string">"expires_in"</span> =&gt; $lifetime,</span><br><span class="line">    ];</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;res-&gt;format(<span class="number">200</span>, $result);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>src/Domain/Auth/Service/LogoutService.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Domain</span>\<span class="title">Auth</span>\<span class="title">Service</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Utils</span>\<span class="title">ResponseFormat</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LogoutService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** <span class="doctag">@var</span> ResponseFormat */</span></span><br><span class="line">  <span class="keyword">private</span> ResponseFormat $res;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> ResponseFormat response</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(ResponseFormat $res)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;res = $res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Logout</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> ResponseFormat </span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">logout</span><span class="params">()</span>: <span class="title">ResponseFormat</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;res-&gt;format(<span class="number">200</span>, <span class="string">"Success"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Repository-1"><a href="#Repository-1" class="headerlink" title="Repository"></a>Repository</h4><p>最後在 <code>src/Domain/Auth</code> 的目錄下新增相對應的 Repository 的 <code>src/Domain/Auth/Repository/AuthRepository.php</code>。</p>
<p><code>src/Domain/Auth/Repository/AuthRepository.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Domain</span>\<span class="title">Auth</span>\<span class="title">Repository</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">UnexpectedValueException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Medoo</span>\<span class="title">Medoo</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthRepository</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">/** <span class="doctag">@var</span> Medoo $DB 連線 */</span></span><br><span class="line">  <span class="keyword">private</span> Medoo $db;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> Medoo $DB 連線</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Medoo $db)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;db = $db;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 登入</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> array|string 欄位</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> array|int WHERE條件</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> string 表名</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">(array | string $params = <span class="string">"*"</span>, array | int $where = <span class="number">1</span>, string $table = <span class="string">"Users"</span>)</span>: <span class="title">array</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;db-&gt;select($table, $params, $where);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PDOException $e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UnexpectedValueException($e-&gt;getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="新增路由"><a href="#新增路由" class="headerlink" title="新增路由"></a>新增路由</h4><p><code>config/routes.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">(App $app)</span> </span>&#123;</span><br><span class="line">  $app-&gt;options(<span class="string">"[&#123;routes.*&#125;]"</span>, <span class="function"><span class="keyword">function</span><span class="params">(Request $req, Response $res, array $args)</span> :<span class="title">Response</span> </span>&#123; <span class="keyword">return</span> $res; &#125;);</span><br><span class="line">  </span><br><span class="line">  $app-&gt;group(<span class="string">"/api"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(RouteCollectorProxy $app)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    $app-&gt;post(<span class="string">"/login[/]"</span>, \App\Action\Auth\LoginAction::class);</span><br><span class="line">    $app-&gt;get(<span class="string">"/logout[/]"</span>, \App\Action\Auth\LogoutAction::class);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"> &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="Jwt驗證是否登入"><a href="#Jwt驗證是否登入" class="headerlink" title="Jwt驗證是否登入"></a>Jwt驗證是否登入</h3><p>由於我們完成了登入登出路由，但是我們必須在 <code>Action</code> 操作之前<code>提前解析 Jwt Token</code>，於是我們就會使用到 <code>Middleware</code> 來<code>預先處理Token</code>。</p>
<h4 id="Middleware-實現"><a href="#Middleware-實現" class="headerlink" title="Middleware 實現"></a>Middleware 實現</h4><p><code>src/Middleware/JwtAuth.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Middleware</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Utils</span>\<span class="title">Jwt</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Utils</span>\<span class="title">ResponseFormat</span>;</span><br><span class="line"><span class="comment">// use Psr\Http\Message\ResponseFactoryInterface;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Slim</span>\<span class="title">Http</span>\<span class="title">Factory</span>\<span class="title">DecoratedResponseFactory</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Psr</span>\<span class="title">Http</span>\<span class="title">Message</span>\<span class="title">ResponseInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Psr</span>\<span class="title">Http</span>\<span class="title">Message</span>\<span class="title">ServerRequestInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Psr</span>\<span class="title">Http</span>\<span class="title">Server</span>\<span class="title">MiddlewareInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Psr</span>\<span class="title">Http</span>\<span class="title">Server</span>\<span class="title">RequestHandlerInterface</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * JWT middleware.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtAuth</span> <span class="keyword">implements</span> <span class="title">MiddlewareInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Jwt JWT authorizer */</span></span><br><span class="line">    <span class="keyword">private</span> Jwt $jwt;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  <span class="doctag">@var</span> DecoratedResponseFactory</span></span><br><span class="line"><span class="comment">     *  The response factory </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> DecoratedResponseFactory $responseFactory;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  <span class="doctag">@var</span> ResponseFormat</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> ResponseFormat $response;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Jwt $jwt, DecoratedResponseFactory $responseFactory, ResponseFormat $response)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;jwt = $jwt;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;responseFactory = $responseFactory;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;response = $response;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Invoke middleware.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ServerRequestInterface $request The request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> RequestHandlerInterface $handler The handler</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ResponseInterface The response</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span><span class="params">(ServerRequestInterface $request, RequestHandlerInterface $handler)</span>: <span class="title">ResponseInterface</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $authorization = explode(<span class="string">" "</span>, (string)$request-&gt;getHeaderLine(<span class="string">"Authorization"</span>));</span><br><span class="line">        $token = $authorization[<span class="number">1</span>] ?? <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判斷有無TOKEN並驗證</span></span><br><span class="line">        <span class="keyword">if</span> (!$token || !<span class="keyword">$this</span>-&gt;jwt-&gt;validateToken($token)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;responseFactory-&gt;createResponse()</span><br><span class="line">                -&gt;withJson(<span class="keyword">$this</span>-&gt;response-&gt;format(<span class="number">403</span>, <span class="string">"請先登入"</span>), <span class="number">200</span>, JSON_UNESCAPED_UNICODE);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Append valid token</span></span><br><span class="line">        $parsedToken = <span class="keyword">$this</span>-&gt;jwt-&gt;createParsedToken($token);</span><br><span class="line">        $request = $request-&gt;withAttribute(<span class="string">"token"</span>, $parsedToken);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Append the info as request attribute</span></span><br><span class="line">        $request = $request-&gt;withAttribute(<span class="string">"info"</span>, $parsedToken-&gt;claims()-&gt;get(<span class="string">"info"</span>));</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> $handler-&gt;handle($request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="新增-Middleware-到路由"><a href="#新增-Middleware-到路由" class="headerlink" title="新增 Middleware 到路由"></a>新增 Middleware 到路由</h4><p><code>config/routes.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">(App $app)</span> </span>&#123;</span><br><span class="line">  $app-&gt;options(<span class="string">"[&#123;routes.*&#125;]"</span>, <span class="function"><span class="keyword">function</span><span class="params">(Request $req, Response $res, array $args)</span> :<span class="title">Response</span> </span>&#123; <span class="keyword">return</span> $res; &#125;);</span><br><span class="line">  </span><br><span class="line">  $app-&gt;group(<span class="string">"/api"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(RouteCollectorProxy $app)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    $app-&gt;get(<span class="string">"/logout[/]"</span>, \App\Action\Auth\LogoutAction::class)-&gt;add(\App\Middleware\JwtAuth::class);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"> &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="成果展示-1"><a href="#成果展示-1" class="headerlink" title="成果展示"></a>成果展示</h3><ul>
<li>使用 postman 進行請求操作，依序是 登出(無 Jwt) -&gt; 登入 -&gt; 登出(有 Jwt)<br><img src="/images/Build-a-PHP-RESTful-Framework-using-Slim-4-Part2/4.jpg" alt=""><br><img src="/images/Build-a-PHP-RESTful-Framework-using-Slim-4-Part2/5.jpg" alt=""><br><img src="/images/Build-a-PHP-RESTful-Framework-using-Slim-4-Part2/6.jpg" alt=""></li>
</ul>
<h2 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h2><h3 id="當前目錄"><a href="#當前目錄" class="headerlink" title="當前目錄"></a>當前目錄</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── config&#x2F;               應用配置目錄</span><br><span class="line">|   ├── bootstrap.php     啟動文件</span><br><span class="line">|   ├── container.php     依賴注入容器文件</span><br><span class="line">|   ├── middleware.php    中間件文件</span><br><span class="line">|   ├── routes.php        路由文件</span><br><span class="line">|   └── settings.php      配置設定文件</span><br><span class="line">├── docker&#x2F;               Docker 相關目錄</span><br><span class="line">|   ├── nginx&#x2F;            Nginx 目錄</span><br><span class="line">│   |   └── default.conf  Nginx 配置文件</span><br><span class="line">|   └── php&#x2F;              PHP 目錄</span><br><span class="line">│       └── Dockerfile    PHP 容器配置文件</span><br><span class="line">├── public&#x2F;               網站根目錄</span><br><span class="line">│   └── index.php         入口文件</span><br><span class="line">├── src&#x2F;                  PHP 原始碼目錄（App Namespace）</span><br><span class="line">│  ├─Action&#x2F;</span><br><span class="line">│  │  ├─Auth&#x2F;</span><br><span class="line">│  │  │ ├─LoginAction.php</span><br><span class="line">│  │  │ └─LogoutAction.php</span><br><span class="line">│  │  └─Users&#x2F;</span><br><span class="line">│  │    ├─GetAction.php</span><br><span class="line">│  │    ├─InsertAction.php</span><br><span class="line">│  │    ├─UpdateAction.php</span><br><span class="line">│  │    └─DeleteAction.php</span><br><span class="line">│  ├─Domain&#x2F;</span><br><span class="line">│  │  ├─Auth&#x2F;</span><br><span class="line">│  │  │  ├─Repository&#x2F;</span><br><span class="line">│  │  │  │ └─AuthRepository.php</span><br><span class="line">│  │  │  └─Service&#x2F;</span><br><span class="line">│  │  │    ├─LoginService.php</span><br><span class="line">│  │  │    └─LogoutService.php</span><br><span class="line">│  │  └─Users&#x2F;</span><br><span class="line">│  │      ├─Repository&#x2F;</span><br><span class="line">│  │      │ └─UsersRepository.php</span><br><span class="line">│  │      └─Service&#x2F;</span><br><span class="line">│  │        ├─GetService.php</span><br><span class="line">│  │        ├─InsertService.php</span><br><span class="line">│  │        ├─UpdateService.php</span><br><span class="line">│  │        └─DeleteService.php</span><br><span class="line">│  ├─Middleware&#x2F;</span><br><span class="line">│  │ └─JwtAuth.php</span><br><span class="line">│  └─Utils&#x2F;</span><br><span class="line">│    ├─Jwt.php</span><br><span class="line">│    ├─Validation.php</span><br><span class="line">│    └─ResponseFormat.php</span><br><span class="line">├── vendor&#x2F;               Composer 目錄</span><br><span class="line">├── .env                  系統變數</span><br><span class="line">├── .gitignore            Git 忽略文件</span><br><span class="line">├── composer.json         Composer 配置文件</span><br><span class="line">├── composer.lock         Composer 鎖定文件</span><br><span class="line">├── docker-compose.yml    Docker 容器配置文件</span><br><span class="line">└── init.sql              DB Schema</span><br></pre></td></tr></table></figure>

<h3 id="未來工作"><a href="#未來工作" class="headerlink" title="未來工作"></a>未來工作</h3><ul>
<li>目前我們已經將 Slim 4 的 ADR 框架建立完成，並且實現 <code>表單驗證</code>、<code>統一回應格式</code>、<code>Jwt</code>、<code>登入登出</code>功能。</li>
<li>下一篇(DevOps篇)，我將會新增 <code>Unit Testing</code>、<code>E2E Testing</code>、<code>Github Actions</code> 等相關功能。</li>
</ul>
<blockquote>
<p>本文範例程式碼在 GitHub 上的 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1BPQUJPQi9TbGltLUFEUg==">POABOB/Slim-ADR<i class="fa fa-external-link-alt"></i></span>。</p>
</blockquote>
<h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9yYWlsc2Jvb2sudHcvY2hhcHRlcnMvMTAtbXZj">Model、View、Controller 三分天下<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZHJzYW53dWppYW5nLmNvbS9zbGltNC1idWlsZC1yZXN0ZnVsLWFwaS8jY3JlYXRlLXNsaW0tYXBwbGljYXRpb24=">Slim 4 搭建 RESTful API<i class="fa fa-external-link-alt"></i></span> </li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZHJzYW53dWppYW5nLmNvbS9zbGltLTQtc2V0dXAtand0Lw==">Slim 4 配置 JSON Web Token<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9vZGFuLmdpdGh1Yi5pby8yMDE5LzExLzA1L3NsaW00LXR1dG9yaWFsLmh0bWw=">Slim 4 - Tutorial<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2J4Y29kZWMvZ28tY2xlYW4tYXJjaA==">bxcodec/go-clean-arch<i class="fa fa-external-link-alt"></i></span></li>
</ul>

    </div>

    
    
    
        <div>
        
            <div style="text-align:center;color: #ccc;font-size:14px;">------ 本文結束 ------</div>
        
        </div>
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>作者： </strong>POABOB
  </li>
  <li class="post-copyright-link">
    <strong>文章連結：</strong>
    <a href="https://poabob.github.io/2022-09-02/Build-a-PHP-RESTful-Framework-using-Slim-4-Part2/" title="使用 PHP Slim 4 建立一個 RESTful 框架 (進階篇)">https://poabob.github.io/2022-09-02/Build-a-PHP-RESTful-Framework-using-Slim-4-Part2/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版權聲明： </strong>本網誌所有文章除特別聲明外，均採用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC96aC1UVw=="><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</span> 許可協議。轉載請註明出處！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Swagger-ui/" rel="tag"># Swagger-ui</a>
              <a href="/tags/PHP/" rel="tag"># PHP</a>
              <a href="/tags/Slim-4/" rel="tag"># Slim 4</a>
              <a href="/tags/RESTful/" rel="tag"># RESTful</a>
              <a href="/tags/Jwt/" rel="tag"># Jwt</a>
              <a href="/tags/Docker/" rel="tag"># Docker</a>
              <a href="/tags/PSR-7/" rel="tag"># PSR-7</a>
              <a href="/tags/PSR-11/" rel="tag"># PSR-11</a>
              <a href="/tags/PSR-15/" rel="tag"># PSR-15</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022-07-28/Build-a-PHP-RESTful-Framework-using-Slim-4-Part1/" rel="prev" title="使用 PHP Slim 4 建立一個 RESTful 框架 (基本配置篇)">
      <i class="fa fa-chevron-left"></i> 使用 PHP Slim 4 建立一個 RESTful 框架 (基本配置篇)
    </a></div>
      <div class="post-nav-item">
    <a href="/2022-09-29/Deploy-a-static-project-using-SSL-DNS-with-a-free-way/" rel="next" title="使用 GCP 建置一個具有 SSL 和 DNS 的靜態網站(完全免費!!!)">
      使用 GCP 建置一個具有 SSL 和 DNS 的靜態網站(完全免費!!!) <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

  <div id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>


        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安裝"><span class="nav-number">2.</span> <span class="nav-text">安裝</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#本機最低需求"><span class="nav-number">2.1.</span> <span class="nav-text">本機最低需求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安裝相關依賴"><span class="nav-number">2.2.</span> <span class="nav-text">安裝相關依賴</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#建構-RESTful-API"><span class="nav-number">3.</span> <span class="nav-text">建構 RESTful API</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#PSR-4"><span class="nav-number">3.1.</span> <span class="nav-text">PSR-4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MVC-模式"><span class="nav-number">3.2.</span> <span class="nav-text">MVC 模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ADR-模式"><span class="nav-number">3.3.</span> <span class="nav-text">ADR 模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Action"><span class="nav-number">3.4.</span> <span class="nav-text">Action</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Service"><span class="nav-number">3.5.</span> <span class="nav-text">Service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Repository"><span class="nav-number">3.6.</span> <span class="nav-text">Repository</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改配置"><span class="nav-number">3.7.</span> <span class="nav-text">修改配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#表單驗證和統一回應格式"><span class="nav-number">4.</span> <span class="nav-text">表單驗證和統一回應格式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#表單驗證"><span class="nav-number">4.1.</span> <span class="nav-text">表單驗證</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#統一回應格式"><span class="nav-number">4.2.</span> <span class="nav-text">統一回應格式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用方式"><span class="nav-number">4.3.</span> <span class="nav-text">使用方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#成果展示"><span class="nav-number">4.4.</span> <span class="nav-text">成果展示</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#登入和Jwt"><span class="nav-number">5.</span> <span class="nav-text">登入和Jwt</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Jwt"><span class="nav-number">5.1.</span> <span class="nav-text">Jwt</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#介紹"><span class="nav-number">5.1.1.</span> <span class="nav-text">介紹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安裝-1"><span class="nav-number">5.1.2.</span> <span class="nav-text">安裝</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#產生公鑰和私鑰"><span class="nav-number">5.1.3.</span> <span class="nav-text">產生公鑰和私鑰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#env配置"><span class="nav-number">5.1.4.</span> <span class="nav-text">.env配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#建立-Jwt-的函式庫"><span class="nav-number">5.1.5.</span> <span class="nav-text">建立 Jwt 的函式庫</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#容器-Jwt-配置"><span class="nav-number">5.1.6.</span> <span class="nav-text">容器 Jwt 配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#登入和登出"><span class="nav-number">5.2.</span> <span class="nav-text">登入和登出</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Action-1"><span class="nav-number">5.2.1.</span> <span class="nav-text">Action</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Service-1"><span class="nav-number">5.2.2.</span> <span class="nav-text">Service</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Repository-1"><span class="nav-number">5.2.3.</span> <span class="nav-text">Repository</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#新增路由"><span class="nav-number">5.2.4.</span> <span class="nav-text">新增路由</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Jwt驗證是否登入"><span class="nav-number">5.3.</span> <span class="nav-text">Jwt驗證是否登入</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Middleware-實現"><span class="nav-number">5.3.1.</span> <span class="nav-text">Middleware 實現</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#新增-Middleware-到路由"><span class="nav-number">5.3.2.</span> <span class="nav-text">新增 Middleware 到路由</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#成果展示-1"><span class="nav-number">5.4.</span> <span class="nav-text">成果展示</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#結語"><span class="nav-number">6.</span> <span class="nav-text">結語</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#當前目錄"><span class="nav-number">6.1.</span> <span class="nav-text">當前目錄</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#未來工作"><span class="nav-number">6.2.</span> <span class="nav-text">未來工作</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#參考資料"><span class="nav-number">7.</span> <span class="nav-text">參考資料</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="POABOB"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">POABOB</p>
  <div class="site-description" itemprop="description">Life is but a span!</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">8</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分類</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">標籤</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1BPQUJPQg==" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;POABOB"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOnp4Yzc1MjE2NkBnbWFpbC5jb20=" title="E-Mail → mailto:zxc752166@gmail.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly93d3cuZmFjZWJvb2suY29tL3Byb2ZpbGUucGhwP2lkPTEwMDAwMDMyMTQwMDU5MA==" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;profile.php?id&#x3D;100000321400590"><i class="fab fa-facebook fa-fw"></i>FB Page</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9pbnN0YWdyYW0uY29tLzB4N2YyZWI=" title="Instagram → https:&#x2F;&#x2F;instagram.com&#x2F;0x7f2eb"><i class="fab fa-instagram fa-fw"></i>Instagram</span>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">POABOB</span>
</div>
  <div class="powered-by">由 <span class="exturl theme-link" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl theme-link" data-url="aHR0cHM6Ly9waXNjZXMudGhlbWUtbmV4dC5vcmc=">NexT.Pisces</span> 強力驅動
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  




  
<script src="/js/local-search.js"></script>















    <div id="pjax">
  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">
<script src="https://gist.githubusercontent.com/POABOB/65b37ccc358df67efffeedf571219b2a/raw/b26f8f05e0951aa1c22d11122f3232b986012141/md5.min.js"></script>
<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '5aa580a2136b90e75fd6',
      clientSecret: '128f00ea948ebd5cb1c0c2c7c3a2b81f067257ea',
      repo        : 'poabob.github.io',
      owner       : 'POABOB',
      admin       : ['POABOB'],
      id          : 'ea29900efae692d49858d366aab14582',
        language: 'en | es-ES | fr | ru | zh-CN | zh-TW',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

    </div>
</body>
</html>
